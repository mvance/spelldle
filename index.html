<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelldle</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.skypack.dev https://esm.sh https://unpkg.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://gist.githubusercontent.com https://*.supabase.co https://cdn.jsdelivr.net; worker-src blob:;">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
    <link rel="manifest" href="favicon_io/site.webmanifest">
    
    <!-- Supabase JavaScript Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Papa Parse CDN -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" 
            integrity="sha384-D/t0ZMqQW31H3az8ktEiNb39wyKnS82iFY52QPACM+IjKW3jDUhyIgh2PApRqJZs" 
            crossorigin="anonymous"></script>
    <!-- Canvas Confetti CDN -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" 
            integrity="sha384-0esPaJH+F9evp2lsJYN36SW7XkRbaYviuyF+PpnbjDXBC9i1CWGiJyGrXCyiyGqZ" 
            crossorigin="anonymous"></script>
    
    <!-- FSRS Library CDN -->
    <script type="module">
        import * as tsFsrs from 'https://cdn.jsdelivr.net/npm/ts-fsrs@5.2.3/+esm';
        window.tsFsrs = tsFsrs;
        console.log('FSRS library loaded via ES modules');
    </script>
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header Controls -->
    <div class="header-controls" id="headerControls">
        <div class="auth-status" id="authStatus" style="display: none;"></div>
        <a href="#" class="logout-link" id="logoutLink" style="display: none;">Sign Out</a>
        <a href="#" class="sign-in-link" id="signInLink" style="display: none;">Sign In</a>
    </div>

    <div class="progress-counter" id="progressCounter" style="display: none;">Word 1 of 12</div>
    
    <div class="game-container" id="gameContainer">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen" style="display: flex;">
            <h1>Spelldle</h1>
            
            <div class="how-to-play">
                <h2>How to Play</h2>
                <ul>
                    <li>Listen carefully as the word and an example sentence are spoken.</li>
                    <li>Type your spelling of the word in the input box and press Enter or click Submit.</li>
                    <li>If your first guess is incorrect, you'll get clues:
                        <div class="clue-examples">
                            <div class="clue-example">
                                <span class="clue-color-box green"></span>
                                Correct letter in the correct position.
                            </div>
                            <div class="clue-example">
                                <span class="clue-color-box yellow"></span>
                                Correct letter in the wrong position.
                            </div>
                            <div class="clue-example">
                                <span class="clue-color-box gray"></span>
                                Letter not in the word.
                            </div>
                            <div class="clue-example">
                                <span class="clue-color-box extraneous"></span>
                                Extra letter (when your guess is too long).
                            </div>
                        </div>
                    </li>
                    <li>Use the clues to guess again in the letter boxes.</li>
                </ul>
            </div>
            
            <div class="lesson-selector" id="lessonSelector">
                <label for="lessonDropdown">Choose a lesson:</label>
                <select id="lessonDropdown" class="lesson-dropdown">
                    <option value="">Loading lessons...</option>
                </select>
                <button class="start-button" id="startLessonButton" onclick="startSelectedLesson()" disabled>Start Lesson</button>
            </div>
        </div>
        
        <button class="start-button" id="startButton" onclick="initializeGame()" style="display: none;">Start Game</button>
        <div class="audio-controls" id="audioControls" style="display: none;">
            <button class="repeat-button" id="repeatButton" onclick="repeatWord()" disabled>Repeat Word</button>
        </div>
        <div class="audio-fallback" id="audioFallback" style="display: none;">
            Audio not supported in this browser
        </div>
        
        <div class="initial-guess-container" id="initialGuessContainer" style="display: none;">
            <div class="input-row">
                <input 
                    type="text" 
                    class="guess-input" 
                    id="guessInput" 
                    placeholder="Type your guess..."
                    spellcheck="false"
                    autocomplete="off"
                    onkeydown="handleInputKeydown(event)"
                    oninput="handleInputChange(event)"
                />
                <button class="submit-button" id="submitButton" onclick="submitGuess()">Submit</button>
            </div>
            <div class="validation-message" id="validationMessage"></div>
        </div>
        
        <div class="clue-phase-container" id="cluePhaseContainer" style="display: none;">
            <!-- Feedback rows will be dynamically added here -->
        </div>
        
        <div class="game-complete-container" id="gameCompleteContainer" style="display: none;">
            <div class="game-complete-message">Game Complete!</div>
            <button class="play-again-button" onclick="playAgain()">Play Again</button>
        </div>
        
        <!-- Lesson Complete Modal -->
        <div class="modal-overlay" id="lessonCompleteModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Complete!</h2>
                <div class="lesson-stats" id="lessonStats"></div>
                <div class="lesson-navigation">
                    <select id="nextActionDropdown" class="lesson-dropdown">
                        <option value="next">Next Lesson</option>
                        <option value="menu">Return to Menu</option>
                    </select>
                    <button class="modal-button" onclick="handleLessonComplete()">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div class="modal-overlay" id="errorModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Load Error</h2>
                <div class="error-details" id="errorDetails"></div>
                <button class="modal-button" onclick="retryLessonLoad()">Retry</button>
            </div>
        </div>
        
        <!-- Authentication Modal -->
        <div class="auth-modal-overlay" id="authModal" style="display: none;">
            <div class="auth-modal-content">
                <!-- Email Input Phase -->
                <div class="auth-phase" id="emailPhase">
                    <h2>Sign In to Save Progress</h2>
                    <p class="auth-description">
                        Sign in to save your spelling progress and track your improvement over time. 
                        Your data will be securely stored and available across all your devices.
                    </p>
                    
                    <div class="auth-form">
                        <div class="auth-input-group">
                            <label for="emailInput">Email Address</label>
                            <input 
                                type="email" 
                                id="emailInput" 
                                class="auth-input" 
                                placeholder="Enter your email address"
                                autocomplete="email"
                                spellcheck="false"
                            />
                        </div>
                        
                        <div class="auth-error" id="emailError" style="display: none;"></div>
                        
                        <div class="auth-buttons">
                            <button class="auth-button primary" id="sendOtpButton">
                                Send Verification Code
                            </button>
                            <button class="auth-button secondary" id="skipAuthButton">
                                Skip and Play Without Saving
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- OTP Verification Phase -->
                <div class="auth-phase" id="otpPhase" style="display: none;">
                    <h2>Verify Your Email</h2>
                    <p class="auth-description">
                        We've sent a 6-digit verification code to <span id="emailDisplay"></span>. 
                        Please enter the code below to complete sign in.
                    </p>
                    
                    <div class="auth-form">
                        <div class="auth-input-group">
                            <label for="otpInput">Verification Code</label>
                            <input 
                                type="text" 
                                id="otpInput" 
                                class="auth-input" 
                                placeholder="Enter 6-digit code"
                                maxlength="6"
                                pattern="[0-9]{6}"
                                autocomplete="one-time-code"
                                spellcheck="false"
                            />
                        </div>
                        
                        <div class="auth-error" id="otpError" style="display: none;"></div>
                        
                        <div class="auth-buttons">
                            <button class="auth-button primary" id="verifyOtpButton">
                                Verify Code
                            </button>
                            <button class="auth-button secondary" id="resendOtpButton">
                                Resend Code
                            </button>
                            <button class="auth-button secondary" id="backToEmailButton">
                                Back to Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module initialization -->
    <script type="module">
        // Import app module and initialize
        import app from './app.js';
        
        // Initialize the application
        app.initialize();
    </script>
</body>
</html>
