<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelldle</title>
    <!-- Papa Parse CDN -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Canvas Confetti CDN -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color scheme variables */
        :root {
            --green: #6aaa64;
            --yellow: #c9b458;
            --gray: #787c7e;
            --blue: #5a9fd4;
            --dark-bg: #121213;
            --dark-text: #ffffff;
            --dark-border: #3a3a3c;
        }

        /* Dark theme styling */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* Progress counter styling */
        .progress-counter {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Main game container */
        .game-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Start button styling */
        .start-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .start-button:hover {
            background-color: #4a8fc4;
        }

        .start-button:active {
            background-color: #3a7fb4;
        }

        /* Audio controls styling */
        .audio-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .repeat-button {
            background-color: var(--gray);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .repeat-button:hover {
            background-color: #686c6f;
        }

        .repeat-button:active {
            background-color: #585c5f;
        }

        .repeat-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .audio-fallback {
            background-color: #444;
            color: var(--yellow);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            margin: 10px 0;
        }

        /* Initial guess input styling */
        .initial-guess-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .guess-input {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 6px;
            min-width: 200px;
            text-align: center;
            font-family: inherit;
        }

        .guess-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .submit-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .submit-button:hover {
            background-color: #4a8fc4;
        }

        .submit-button:active {
            background-color: #3a7fb4;
        }

        .submit-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .validation-message {
            color: var(--yellow);
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }

        /* Game completion styling */
        .game-complete-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .game-complete-message {
            font-size: 24px;
            font-weight: bold;
            color: var(--blue);
        }

        .play-again-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .play-again-button:hover {
            background-color: #4a8fc4;
        }

        .play-again-button:active {
            background-color: #3a7fb4;
        }

        /* Clue phase feedback styling */
        .clue-phase-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }

        .feedback-rows-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .feedback-row {
            display: flex;
            gap: 5px;
            justify-content: flex-start;
            margin: 5px 0;
        }

        .letter-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: 3px solid #d3d6da;
            border-radius: 3px;
            font-weight: bold;
            font-size: 18px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .letter-box.green {
            background-color: var(--green);
            color: white;
        }

        .letter-box.yellow {
            background-color: var(--yellow);
            color: white;
        }

        .letter-box.gray {
            background-color: var(--gray);
            color: white;
        }

        .letter-box.extraneous {
            border: 3px dotted #d3d6da;
        }

        .letter-box.missing {
            background-color: transparent;
            border: 3px solid #d3d6da;
            color: var(--dark-text);
        }

        /* Clue phase input styling */
        .input-row-clue {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
        }

        .letter-input {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: 3px solid #d3d6da;
            border-radius: 3px;
            font-weight: bold;
            font-size: 18px;
            box-sizing: border-box;
            text-align: center;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            font-family: inherit;
        }

        .letter-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .clue-submit-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .clue-submit-button:hover {
            background-color: #4a8fc4;
        }

        .clue-submit-button:active {
            background-color: #3a7fb4;
        }

        .clue-submit-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Reinforcement phase styling */
        .reinforcement-input-row {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
        }

        .reinforcement-submit-button {
            background-color: var(--green);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .reinforcement-submit-button:hover {
            background-color: #5a9a54;
        }

        .reinforcement-submit-button:active {
            background-color: #4a8a44;
        }

        .reinforcement-submit-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .game-container {
                max-width: 100%;
                padding: 15px;
            }
            
            .progress-counter {
                font-size: 16px;
                margin-bottom: 20px;
            }
            
            .letter-box, .letter-input {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .feedback-row, .input-row-clue {
                gap: 3px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            .letter-box, .letter-input {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .feedback-row, .input-row-clue {
                gap: 2px;
            }
            
            .guess-input {
                min-width: 150px;
                font-size: 14px;
            }
            
            .submit-button, .clue-submit-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        /* Welcome screen styling */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .welcome-screen h1 {
            font-size: 48px;
            font-weight: bold;
            color: var(--blue);
            margin: 0;
        }

        .how-to-play {
            background-color: #2a2a2a;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            text-align: left;
        }

        .how-to-play h2 {
            color: var(--blue);
            margin-bottom: 15px;
            font-size: 20px;
        }

        .how-to-play ul {
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
            list-style: none;
        }

        .how-to-play li {
            margin-bottom: 12px;
            position: relative;
            padding-left: 8px;
        }

        .how-to-play li::before {
            content: "â€¢";
            position: absolute;
            left: -12px;
            color: var(--blue);
            font-weight: bold;
        }

        .clue-examples {
            margin: 8px 0;
            padding-left: 20px;
        }

        .clue-example {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .clue-color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 6px;
            display: inline-block;
        }

        .clue-color-box.green {
            background-color: var(--green);
        }

        .clue-color-box.yellow {
            background-color: var(--yellow);
        }

        .clue-color-box.gray {
            background-color: var(--gray);
        }

        .lesson-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .lesson-selector label {
            font-size: 18px;
            font-weight: bold;
        }

        .lesson-dropdown {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 6px;
            min-width: 250px;
            font-family: inherit;
        }

        .lesson-dropdown:focus {
            outline: none;
            border-color: var(--blue);
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            color: var(--blue);
            margin-bottom: 20px;
        }

        .lesson-stats {
            margin: 20px 0;
            font-size: 16px;
            line-height: 1.8;
        }

        .lesson-navigation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #4a8fc4;
        }

        .modal-button:active {
            background-color: #3a7fb4;
        }

        .error-details {
            background-color: #2a2a2a;
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 320px) {
            .letter-box, .letter-input {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
            
            .guess-input {
                min-width: 120px;
            }
            
            .welcome-screen h1 {
                font-size: 36px;
            }
            
            .lesson-dropdown {
                min-width: 200px;
                font-size: 14px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="progress-counter" id="progressCounter" style="display: none;">Word 1 of 12</div>
    
    <div class="game-container" id="gameContainer">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen" style="display: flex;">
            <h1>Spelldle</h1>
            
            <div class="how-to-play">
                <h2>How to Play</h2>
                <ul>
                    <li>Listen carefully as the word and an example sentence are spoken.</li>
                    <li>Type your spelling of the word in the input box and press Enter or click Submit.</li>
                    <li>If your first guess is incorrect, you'll get clues:
                        <div class="clue-examples">
                            <div class="clue-example">
                                <span class="clue-color-box green"></span>
                                Correct letter in the correct position.
                            </div>
                            <div class="clue-example">
                                <span class="clue-color-box yellow"></span>
                                Correct letter in the wrong position.
                            </div>
                            <div class="clue-example">
                                <span class="clue-color-box gray"></span>
                                Letter not in the word.
                            </div>
                        </div>
                    </li>
                    <li>Use the clues to guess again in the letter boxes.</li>
                </ul>
            </div>
            
            <div class="lesson-selector" id="lessonSelector">
                <label for="lessonDropdown">Choose a lesson:</label>
                <select id="lessonDropdown" class="lesson-dropdown">
                    <option value="">Loading lessons...</option>
                </select>
                <button class="start-button" id="startLessonButton" onclick="startSelectedLesson()" disabled>Start Lesson</button>
            </div>
        </div>
        
        <button class="start-button" id="startButton" onclick="initializeGame()" style="display: none;">Start Game</button>
        <div class="audio-controls" id="audioControls" style="display: none;">
            <button class="repeat-button" id="repeatButton" onclick="repeatWord()" disabled>Repeat Word</button>
        </div>
        <div class="audio-fallback" id="audioFallback" style="display: none;">
            Audio not supported in this browser
        </div>
        
        <div class="initial-guess-container" id="initialGuessContainer" style="display: none;">
            <div class="input-row">
                <input 
                    type="text" 
                    class="guess-input" 
                    id="guessInput" 
                    placeholder="Type your guess..."
                    spellcheck="false"
                    autocomplete="off"
                    onkeydown="handleInputKeydown(event)"
                    oninput="handleInputChange(event)"
                />
                <button class="submit-button" id="submitButton" onclick="submitGuess()">Submit</button>
            </div>
            <div class="validation-message" id="validationMessage"></div>
        </div>
        
        <div class="clue-phase-container" id="cluePhaseContainer" style="display: none;">
            <!-- Feedback rows will be dynamically added here -->
        </div>
        
        <div class="game-complete-container" id="gameCompleteContainer" style="display: none;">
            <div class="game-complete-message">Game Complete!</div>
            <button class="play-again-button" onclick="playAgain()">Play Again</button>
        </div>
        
        <!-- Lesson Complete Modal -->
        <div class="modal-overlay" id="lessonCompleteModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Complete!</h2>
                <div class="lesson-stats" id="lessonStats"></div>
                <div class="lesson-navigation">
                    <select id="nextActionDropdown" class="lesson-dropdown">
                        <option value="next">Next Lesson</option>
                        <option value="menu">Return to Menu</option>
                    </select>
                    <button class="modal-button" onclick="handleLessonComplete()">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div class="modal-overlay" id="errorModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Load Error</h2>
                <div class="error-details" id="errorDetails"></div>
                <button class="modal-button" onclick="retryLessonLoad()">Retry</button>
            </div>
        </div>
    </div>

    <script>
        // Embedded CSV data (to avoid CORS issues with file:// protocol)
        const EMBEDDED_CSV_DATA = `Lesson Name,Word,Example Sentence
Lesson 1,in,The cat is in the box.
Lesson 1,pin,I need a pin for my shirt.
Lesson 1,tin,The cookies are in the tin.
Lesson 1,spin,Watch the top spin fast.
Lesson 2,I,I like to read books.
Lesson 2,pins,She put pins in the cushion.
Lesson 2,tins,We stacked the empty tins.
Lesson 2,spins,The dancer spins on her toes.
Lesson 2,kin,My kin live nearby.
Lesson 2,skin,My skin feels soft.
Lesson 2,win,I hope to win the game.
Lesson 2,twin,My twin is my best friend.
Lesson 3,thin,The paper is very thin.
Lesson 3,pinned,She pinned the note up.
Lesson 3,tinned,We ate tinned peaches.
Lesson 3,I,I saw a bird outside.
Lesson 3,shin,I bumped my shin on the step.
Lesson 3,skins,The apple skins are red.
Lesson 3,wins,He wins every race.
Lesson 3,twins,The twins wore matching hats.
Lesson 3,be,I want to be a helper.
Lesson 3,begin,Let's begin the lesson.
Lesson 3,chin,He rested his chin on his hand.
Lesson 3,she,She smiled at me.
Lesson 4,thins,The soup thins as you add water.
Lesson 4,pinning,She is pinning up her hair.
Lesson 4,tinning,He is tinning the roof.
Lesson 4,spinning,The wheel is spinning quickly.
Lesson 4,shins,My shins hurt after running.
Lesson 4,skinned,He skinned his knee.
Lesson 4,winning,She is winning the contest.
Lesson 4,inner,The inner circle is blue.
Lesson 4,be,I will be on time.
Lesson 4,begins,School begins at eight.
Lesson 4,chins,The children touched their chins.
Lesson 4,we,We are going to the park.
Lesson 4,wee,The puppy is very wee.
Lesson 4,bee,A bee landed on the flower.
Lesson 4,see,I see a rainbow.
Lesson 4,tree,The tree is tall.
Lesson 5,thinned,The sauce thinned after boiling.
Lesson 5,thinner,This book is thinner than that one.
Lesson 5,tinner,The tinner fixed the roof.
Lesson 5,spinner,The spider is a fast spinner.
Lesson 5,fins,The fish has bright fins.
Lesson 5,dinner,We had pizza for dinner.
Lesson 5,winner,The winner gets a prize.
Lesson 5,be,Please be careful.
Lesson 5,inning,The second inning just ended.
Lesson 5,beginning,The story has a happy beginning.
Lesson 5,chinned,He chinned himself on the bar.
Lesson 5,we,We saw a movie.
Lesson 5,wee,The kitten is so wee.
Lesson 5,bee,The bee buzzed by.
Lesson 5,see,Can you see the moon?
Lesson 5,trees,The trees sway in the wind.
Lesson 5,free,The bird is free now.
Lesson 5,agree,I agree with you.
Lesson 5,disagree,They disagree on the answer.
Lesson 5,fees,The library has no fees.
Lesson 6,thinning,The crowd is thinning out.
Lesson 6,thinnest,This line is the thinnest.
Lesson 6,tinners,The tinners worked all day.
Lesson 6,spinners,The spinners made yarn.
Lesson 6,shin,He scraped his shin.
Lesson 6,inn,We stayed at a cozy inn.
Lesson 6,winners,The winners cheered loudly.
Lesson 6,bee,The bee made honey.
Lesson 6,innings,There are nine innings in baseball.
Lesson 6,beginnings,New beginnings feel exciting.
Lesson 6,chinning,She is chinning at the gym.
Lesson 6,wee,The baby made a wee sound.
Lesson 6,we,We finished our homework.
Lesson 6,bees,Bees collect nectar.
Lesson 6,sees,He sees a butterfly.
Lesson 6,treed,The cat was treed by a dog.
Lesson 6,frees,She frees the bird.
Lesson 6,agrees,He agrees with the plan.
Lesson 6,disagrees,She disagrees with his idea.
Lesson 6,flea,My dog has a flea.
Lesson 7,thin,Cut a thin slice of bread.
Lesson 7,in,The toy is in the box.
Lesson 7,inn,We slept at the inn.
Lesson 7,spin,Spin the wheel now.
Lesson 7,tins,The tins are empty.
Lesson 7,skinny,The cat looks skinny.
Lesson 7,winning,She is winning the race.
Lesson 7,be,Be kind to others.
Lesson 7,inner,The inner page is blank.
Lesson 7,beginner,I am a beginner at chess.
Lesson 7,chin,Touch your chin gently.
Lesson 7,wee,The frog is wee.
Lesson 7,we,We played outside.
Lesson 7,bee,The bee flew away.
Lesson 7,seeing,I am seeing stars tonight.
Lesson 7,treeing,The dog is treeing a raccoon.
Lesson 7,freed,They freed the trapped bird.
Lesson 7,agreed,We agreed to share.
Lesson 7,disagreed,They disagreed on the rules.
Lesson 7,flees,The mouse flees from the cat.
Lesson 8,thinner,My notebook is thinner than yours.
Lesson 8,ins,The coach tracks the ins and outs.
Lesson 8,inns,There are many inns in town.
Lesson 8,spinning,The top is spinning fast.
Lesson 8,tin,The tin is shiny.
Lesson 8,skins,The skins are in the basket.
Lesson 8,winner,The winner smiles.
Lesson 8,be,Be ready at noon.
Lesson 8,being,Being helpful is nice.
Lesson 8,beginners,The beginners are learning.
Lesson 8,chins,They lifted their chins.
Lesson 8,we,We like to sing.
Lesson 8,wee,The ducklings are wee.
Lesson 8,bees,Bees are buzzing.
Lesson 8,see,I see my friend.
Lesson 8,trees,The trees are green.
Lesson 8,freeing,He is freeing the fish.
Lesson 8,agreeing,They are agreeing on a plan.
Lesson 8,disagreeing,They are disagreeing again.
Lesson 8,fleeing,The deer is fleeing danger.
Lesson 9,up,Look up at the sky.
Lesson 9,cup,I dropped my cup.
Lesson 9,pup,The pup barked.
Lesson 9,sup,Let's sup together.
Lesson 9,good,That was a good meal.
Lesson 9,wood,The chair is made of wood.
Lesson 9,stood,She stood in line.
Lesson 9,could,I could help you.
Lesson 9,would,I would like some juice.
Lesson 9,food,The food smells great.
Lesson 9,mood,He is in a happy mood.
Lesson 9,brood,The hen has a brood of chicks.
Lesson 9,out,Go out to play.
Lesson 9,shout,Please do not shout.
Lesson 9,bout,He won the last bout.
Lesson 9,lout,The lout made a mess.
Lesson 9,clout,She has clout at work.
Lesson 9,flout,Do not flout the rules.
Lesson 9,pout,She began to pout.
Lesson 9,spout,Water came from the spout.
Lesson 9,rout,The team suffered a rout.
Lesson 9,grout,He filled the gaps with grout.
Lesson 9,route,Which route will you take?
Lesson 9,should,You should try again.
Lesson 9,eye,My eye is blue.
Lesson 10,ups,There are many ups and downs.
Lesson 10,cups,The cups are on the shelf.
Lesson 10,pups,Three pups were born.
Lesson 10,sups,He sups on soup.
Lesson 10,goods,The goods arrived today.
Lesson 10,woods,The woods are quiet.
Lesson 10,stood,He stood by the window.
Lesson 10,could,She could swim fast.
Lesson 10,would,I would call you.
Lesson 10,wouldn't,I wouldn't do that.
Lesson 10,moods,Their moods changed.
Lesson 10,broods,The duck broods her eggs.
Lesson 10,outs,There were two outs in the game.
Lesson 10,shouts,The crowd shouts loudly.
Lesson 10,bouts,He had three bouts today.
Lesson 10,louts,The louts left trash.
Lesson 10,clouts,She clouts the ball hard.
Lesson 10,flouts,He flouts the rules.
Lesson 10,pouts,The child pouts often.
Lesson 10,spouts,The whale spouts water.
Lesson 10,routs,The team routs its rivals.
Lesson 10,about,Tell me about your trip.
Lesson 10,routes,There are two routes home.
Lesson 10,shouldn't,You shouldn't be late.
Lesson 10,eyes,Her eyes are brown.
Lesson 11,up,Jump up high.
Lesson 11,cupped,He cupped water in his hands.
Lesson 11,puppy,The puppy wagged its tail.
Lesson 11,supped,We supped at dusk.
Lesson 11,goody,She got a goody bag.
Lesson 11,wooded,The path is wooded.
Lesson 11,stood,The dog stood still.
Lesson 11,could,I could see the stars.
Lesson 11,would,Would you like tea?
Lesson 11,food,The food is hot.
Lesson 11,mood,His mood is bright.
Lesson 11,brooded,The hen brooded her eggs.
Lesson 11,outing,We went on an outing.
Lesson 11,shouted,He shouted for help.
Lesson 11,about,She talked about her day.
Lesson 11,stout,The mug is stout.
Lesson 11,clouted,He clouted the ball.
Lesson 11,flouted,She flouted the advice.
Lesson 11,pouted,The baby pouted.
Lesson 11,spouted,The whale spouted water.
Lesson 11,grouted,He grouted the tiles.
Lesson 11,wouldn't,I wouldn't lie.
Lesson 11,routed,The team routed its rivals.
Lesson 11,couldn't,I couldn't find my keys.
Lesson 11,eye,Cover your eye gently.
Lesson 12,ups,There are ups and downs in life.
Lesson 12,cupping,She is cupping her hands.
Lesson 12,eye,My puppy's eye is blue.
Lesson 12,supping,We are supping together.
Lesson 12,good,That is a good idea.
Lesson 12,wooden,The box is wooden.
Lesson 12,stood,He stood by the door.
Lesson 12,could,I could do that.
Lesson 12,would,Would you help me?
Lesson 12,wouldn't,She wouldn't go outside.
Lesson 12,moods,Their moods are cheerful.
Lesson 12,brooding,The hen is brooding now.
Lesson 12,outing,We had a fun outing.
Lesson 12,shouting,The fans are shouting.
Lesson 12,about,Tell me about your pet.
Lesson 12,stout,The mug is stout and strong.
Lesson 12,clouting,He is clouting the ball.
Lesson 12,flouting,She is flouting the rules.
Lesson 12,pouting,The child is pouting now.
Lesson 12,spouting,Water is spouting up.
Lesson 12,routing,The driver is routing the trip.
Lesson 12,shouldn't,You shouldn't run inside.
Lesson 12,grouting,He is grouting the tiles.
Lesson 12,couldn't,I couldn't see well.
Lesson 12,eyes,My eyes are tired.
tutoring,goal,My goal is to finish my homework tonight.
tutoring,hurt,I hurt my knee when I fell down.
tutoring,pull,Please pull the door to open it.
tutoring,wild,The wild animals live in the forest.
tutoring,body,Exercise is good for your body.
tutoring,peas,I like to eat green peas with dinner.
tutoring,fruit,An apple is my favorite fruit.
tutoring,great,You did a great job on your test.
tutoring,brain,Your brain helps you think and learn.
tutoring,yummy,The chocolate cake tastes yummy.
tutoring,action,The movie had lots of action scenes.
tutoring,health,Eating vegetables is good for your health.
tutoring,safety,Always wear your helmet for safety.
tutoring,soccer,We kicked the soccer ball in the park.
tutoring,temper,Try to control your temper when angry.
tutoring,pulled,She pulled the rope to ring the bell.
tutoring,bodies,Our bodies need water to stay healthy.
tutoring,choices,You have many choices for lunch today.
tutoring,friends,My friends and I love to play together.
tutoring,practice,I need to practice piano every day.
tutoring,teachers,Our teachers help us learn new things.
tutoring,throwing,He is throwing the ball to his friend.
tutoring,ourselves,We can do this project by ourselves.
tutoring,patience,You need patience when learning something new.
tutoring,attention,Please pay attention to the lesson.
tutoring,dangerous,It is dangerous to play near the street.
tutoring,decisions,Making good decisions is important.
tutoring,furniture,The furniture in our classroom is comfortable.
tutoring,gardening,My mom enjoys gardening in the backyard.
tutoring,understand,I understand the math problem now.
tutoring,poise,The dancer moved with grace and poise.
tutoring,confidence,She has confidence in her abilities.
tutoring,motivation,His motivation to succeed is very strong.
tutoring,precautions,We take precautions to stay safe.
tutoring,determination,With determination you can achieve your goals.
tutoring 2,hurt,I hurt my knee when I fell down.
tutoring 2,wild,The wild animals live in the forest.
tutoring 2,body,Exercise is good for your body.
tutoring 2,peas,I like to eat green peas with dinner.
tutoring 2,fruit,An apple is my favorite fruit.
tutoring 2,great,You did a great job on your test.
tutoring 2,yummy,The chocolate cake tastes yummy.
tutoring 2,health,Eating vegetables is good for your health.
tutoring 2,safety,Always wear your helmet for safety.
tutoring 2,pulled,She pulled the rope to ring the bell.
tutoring 2,choices,You have many choices for lunch today.
tutoring 2,friends,My friends and I love to play together.
tutoring 2,practice,I need to practice piano every day.
tutoring 2,teachers,Our teachers help us learn new things.
tutoring 2,throwing,He is throwing the ball to his friend.
tutoring 2,ourselves,We can do this project by ourselves.
tutoring 2,patience,You need patience when learning something new.
tutoring 2,attention,Please pay attention to the lesson.
tutoring 2,dangerous,It is dangerous to play near the street.
tutoring 2,decisions,Making good decisions is important.
tutoring 2,furniture,The furniture in our classroom is comfortable.
tutoring 2,gardening,My mom enjoys gardening in the backyard.
tutoring 2,poise,The dancer moved with grace and poise.
tutoring 2,precautions,We take precautions to stay safe.
tutoring 3,wild,The wild animals live in the forest.
tutoring 3,body,Exercise is good for your body.
tutoring 3,health,Eating vegetables is good for your health.
tutoring 3,safety,Always wear your helmet for safety.
tutoring 3,pulled,She pulled the rope to ring the bell.
tutoring 3,choices,You have many choices for lunch today.
tutoring 3,friends,My friends and I love to play together.
tutoring 3,practice,I need to practice piano every day.
tutoring 3,teachers,Our teachers help us learn new things.
tutoring 3,throwing,He is throwing the ball to his friend.
tutoring 3,ourselves,We can do this project by ourselves.
tutoring 3,patience,You need patience when learning something new.
tutoring 3,attention,Please pay attention to the lesson.
tutoring 3,dangerous,It is dangerous to play near the street.
tutoring 3,decisions,Making good decisions is important.
tutoring 3,furniture,The furniture in our classroom is comfortable.
tutoring 3,poise,The dancer moved with grace and poise.
tutoring 3,precautions,We take precautions to stay safe.`;

        // Lesson data
        let lessonsData = [];
        let availableLessons = [];
        
        // Fallback word list (original hardcoded words)
        const fallbackWordList = [
            { word: "friend", sentence: "She is my best friend." },
            { word: "bright", sentence: "The sun is very bright today." },
            { word: "school", sentence: "I walk to school every morning." },
            { word: "enough", sentence: "We have enough food for dinner." },
            { word: "through", sentence: "The ball went through the window." },
            { word: "because", sentence: "I stayed home because I was sick." },
            { word: "different", sentence: "Each snowflake is different." },
            { word: "beautiful", sentence: "The sunset was beautiful tonight." },
            { word: "important", sentence: "It's important to brush your teeth." },
            { word: "knowledge", sentence: "Reading books increases your knowledge." },
            { word: "rhythm", sentence: "The music has a steady rhythm." },
            { word: "necessary", sentence: "Sleep is necessary for good health." }
        ];

        // Game state variables
        const gameState = {
            currentWordIndex: 0,
            currentPhase: 'initial', // 'initial', 'clue', or 'reinforcement'
            totalWords: 0,
            currentWord: null,
            currentSentence: null,
            gameStarted: false,
            currentLesson: null,
            currentLessonWords: [],
            correctGuesses: 0,
            totalGuesses: 0,
            lessonStartTime: null,
            hadIncorrectGuess: false // Track if user made incorrect guess in initial phase
        };

        // Text-to-speech variables
        let ttsSupported = false;
        let currentUtterance = null;
        let synth = null;

        // Parse embedded CSV lessons
        function loadLessons() {
            return new Promise((resolve, reject) => {
                console.log('Loading lessons from embedded CSV data...');
                
                Papa.parse(EMBEDDED_CSV_DATA, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            reject(new Error(`CSV Parse Error: ${results.errors.map(e => e.message).join(', ')}`));
                            return;
                        }
                        
                        // Map CSV headers to expected format
                        const headers = results.meta.fields || [];
                        
                        // Check if we have the expected headers (with flexible naming)
                        const hasLessonName = headers.includes('Lesson Name') || headers.includes('lesson_name');
                        const hasWord = headers.includes('Word') || headers.includes('word');
                        const hasSentence = headers.includes('Example Sentence') || headers.includes('sentence');
                        
                        if (!hasLessonName || !hasWord || !hasSentence) {
                            reject(new Error(`Missing required columns. Found: ${headers.join(', ')}`));
                            return;
                        }
                        
                        // Normalize the data to use consistent field names
                        lessonsData = results.data.map(row => ({
                            lesson_name: row['Lesson Name'] || row['lesson_name'],
                            word: row['Word'] || row['word'],
                            sentence: row['Example Sentence'] || row['sentence']
                        })).filter(row => row.lesson_name && row.word && row.sentence);
                        
                        // Clean up any problematic entries (filter out entries with spaces in word field)
                        lessonsData = lessonsData.filter(row => {
                            if (row.word.includes(' ') && row.word.trim() !== row.word) {
                                console.warn(`Skipping problematic word entry: "${row.word}"`);
                                return false;
                            }
                            return true;
                        });
                        
                        availableLessons = [...new Set(lessonsData.map(row => row.lesson_name))].filter(Boolean);
                        
                        console.log(`Loaded ${lessonsData.length} words across ${availableLessons.length} lessons`);
                        console.log('Available lessons:', availableLessons);
                        resolve();
                    },
                    error: function(error) {
                        reject(new Error(`Papa Parse Error: ${error.message}`));
                    }
                });
            });
        }

        // Show error modal with detailed information
        function showErrorModal(error, response = null) {
            const modal = document.getElementById('errorModal');
            const details = document.getElementById('errorDetails');
            
            const errorInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: CSV_URL,
                error: error.message,
                stack: error.stack
            };
            
            if (response) {
                errorInfo.httpStatus = response.status;
                errorInfo.httpStatusText = response.statusText;
                errorInfo.responseHeaders = Object.fromEntries(response.headers.entries());
            }
            
            details.textContent = JSON.stringify(errorInfo, null, 2);
            modal.style.display = 'flex';
            
            // Disable all controls
            disableAllControls();
        }

        // Disable all game controls
        function disableAllControls() {
            const controls = document.querySelectorAll('button, input, select');
            controls.forEach(control => {
                if (!control.onclick || control.onclick.toString().indexOf('retryLessonLoad') === -1) {
                    control.disabled = true;
                }
            });
        }

        // Enable all game controls
        function enableAllControls() {
            const controls = document.querySelectorAll('button, input, select');
            controls.forEach(control => control.disabled = false);
        }

        // Retry lesson loading
        function retryLessonLoad() {
            const modal = document.getElementById('errorModal');
            modal.style.display = 'none';
            enableAllControls();
            initializeLessons();
        }

        // Populate lesson dropdown
        function populateLessonDropdown() {
            const dropdown = document.getElementById('lessonDropdown');
            const startButton = document.getElementById('startLessonButton');
            
            dropdown.innerHTML = '<option value="">Select a lesson...</option>';
            
            availableLessons.forEach(lessonName => {
                const option = document.createElement('option');
                option.value = lessonName;
                option.textContent = lessonName;
                dropdown.appendChild(option);
            });
            
            // Remove any existing event listeners and add new one
            dropdown.removeEventListener('change', handleLessonDropdownChange);
            dropdown.addEventListener('change', handleLessonDropdownChange);
            
            startButton.disabled = true;
        }

        // Handle lesson dropdown change
        function handleLessonDropdownChange() {
            const dropdown = document.getElementById('lessonDropdown');
            const startButton = document.getElementById('startLessonButton');
            startButton.disabled = !dropdown.value;
        }

        // Show fallback when lessons fail to load
        function showLessonLoadFallback() {
            const dropdown = document.getElementById('lessonDropdown');
            dropdown.innerHTML = '<option value="">Failed to load lessons</option>';
            
            // Add fallback option to use original word list
            const fallbackOption = document.createElement('option');
            fallbackOption.value = 'fallback';
            fallbackOption.textContent = 'Original Word List (Fallback)';
            dropdown.appendChild(fallbackOption);
            
            dropdown.addEventListener('change', function() {
                const startButton = document.getElementById('startLessonButton');
                startButton.disabled = !this.value;
                if (this.value === 'fallback') {
                    startButton.textContent = 'Start Game';
                } else {
                    startButton.textContent = 'Start Lesson';
                }
            });
        }

        // Start selected lesson
        function startSelectedLesson() {
            const dropdown = document.getElementById('lessonDropdown');
            const selectedLesson = dropdown.value;
            
            if (!selectedLesson) return;
            
            if (selectedLesson === 'fallback') {
                // Use fallback word list
                gameState.currentLesson = null;
                gameState.currentLessonWords = [];
                gameState.totalWords = fallbackWordList.length;
                gameState.currentWordIndex = 0;
                gameState.correctGuesses = 0;
                gameState.totalGuesses = 0;
                gameState.lessonStartTime = Date.now();
                
                console.log('Starting fallback game with original word list');
            } else {
                // Filter words for selected lesson
                gameState.currentLesson = selectedLesson;
                gameState.currentLessonWords = lessonsData.filter(row => row.lesson_name === selectedLesson);
                gameState.totalWords = gameState.currentLessonWords.length;
                gameState.currentWordIndex = 0;
                gameState.correctGuesses = 0;
                gameState.totalGuesses = 0;
                gameState.lessonStartTime = Date.now();
                
                console.log(`Starting lesson: ${selectedLesson} with ${gameState.totalWords} words`);
            }
            
            // Hide welcome screen and start game
            document.getElementById('welcomeScreen').style.display = 'none';
            initializeGame();
        }

        // Handle lesson completion
        function handleLessonCompletion() {
            console.log('Lesson completed!');
            
            // Calculate stats
            const accuracy = gameState.totalGuesses > 0 ? Math.round((gameState.correctGuesses / gameState.totalGuesses) * 100) : 0;
            const duration = Math.round((Date.now() - gameState.lessonStartTime) / 1000);
            
            // Hide game elements
            hideInitialGuessInput();
            hideCluePhase();
            
            // Show lesson complete modal
            const modal = document.getElementById('lessonCompleteModal');
            const stats = document.getElementById('lessonStats');
            const dropdown = document.getElementById('nextActionDropdown');
            
            stats.innerHTML = `
                <div><strong>Lesson:</strong> ${gameState.currentLesson}</div>
                <div><strong>Words:</strong> ${gameState.totalWords}</div>
                <div><strong>Accuracy:</strong> ${accuracy}% (${gameState.correctGuesses}/${gameState.totalGuesses})</div>
                <div><strong>Time:</strong> ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}</div>
            `;
            
            // Check if there's a next lesson
            const currentLessonIndex = availableLessons.indexOf(gameState.currentLesson);
            const hasNextLesson = currentLessonIndex < availableLessons.length - 1;
            
            dropdown.innerHTML = '';
            if (hasNextLesson) {
                const nextLesson = availableLessons[currentLessonIndex + 1];
                dropdown.innerHTML += `<option value="next">Next Lesson: ${nextLesson}</option>`;
            }
            dropdown.innerHTML += '<option value="menu">Return to Menu</option>';
            
            modal.style.display = 'flex';
        }

        // Handle lesson complete action
        function handleLessonComplete() {
            const dropdown = document.getElementById('nextActionDropdown');
            const action = dropdown.value;
            const modal = document.getElementById('lessonCompleteModal');
            
            modal.style.display = 'none';
            
            if (action === 'next') {
                // Start next lesson
                const currentLessonIndex = availableLessons.indexOf(gameState.currentLesson);
                const nextLesson = availableLessons[currentLessonIndex + 1];
                
                if (nextLesson) {
                    const lessonDropdown = document.getElementById('lessonDropdown');
                    lessonDropdown.value = nextLesson;
                    startSelectedLesson();
                }
            } else {
                // Return to menu
                returnToWelcomeScreen();
            }
        }

        // Return to welcome screen
        function returnToWelcomeScreen() {
            // Reset game state
            gameState.currentLesson = null;
            gameState.currentLessonWords = [];
            gameState.gameStarted = false;
            gameState.currentWordIndex = 0;
            gameState.hadIncorrectGuess = false;
            
            // Hide all game elements
            hideInitialGuessInput();
            hideCluePhase();
            document.getElementById('gameCompleteContainer').style.display = 'none';
            document.getElementById('audioControls').style.display = 'none';
            document.getElementById('progressCounter').style.display = 'none';
            
            // Show welcome screen
            document.getElementById('welcomeScreen').style.display = 'flex';
            
            // Reset lesson dropdown
            document.getElementById('lessonDropdown').value = '';
            document.getElementById('startLessonButton').disabled = true;
        }

        // Initialize lessons on page load
        function initializeLessons() {
            try {
                console.log('Starting lesson initialization...');
                loadLessons().then(() => {
                    populateLessonDropdown();
                    console.log('Lessons initialized successfully');
                }).catch(error => {
                    console.error('Failed to initialize lessons:', error);
                    // Show fallback option if lessons fail to load
                    showLessonLoadFallback();
                    showErrorModal(error);
                });
            } catch (error) {
                console.error('Failed to initialize lessons:', error);
                showLessonLoadFallback();
                showErrorModal(error);
            }
        }

        // Track guesses for lesson stats
        function trackGuess(isCorrect) {
            gameState.totalGuesses++;
            if (isCorrect) {
                gameState.correctGuesses++;
            }
        }

        // LocalStorage functions for spelling attempts
        function saveSpellingAttempt(guess, isCorrect) {
            try {
                const attempt = {
                    user_email: null, // No user-specific tracking for now
                    timestamp: new Date().toISOString(),
                    lesson_name: gameState.currentLesson || 'Fallback Word List',
                    word_target: gameState.currentWord,
                    spelling_guess: guess,
                    result: isCorrect ? 'correct' : 'incorrect'
                };

                // Get existing attempts from localStorage
                const existingAttempts = JSON.parse(localStorage.getItem('spelldle_attempts') || '[]');
                
                // Add new attempt
                existingAttempts.push(attempt);
                
                // Save back to localStorage
                localStorage.setItem('spelldle_attempts', JSON.stringify(existingAttempts));
                
                console.log('Saved spelling attempt:', attempt);
            } catch (error) {
                console.error('Failed to save spelling attempt:', error);
            }
        }

        function getSpellingAttempts() {
            try {
                return JSON.parse(localStorage.getItem('spelldle_attempts') || '[]');
            } catch (error) {
                console.error('Failed to retrieve spelling attempts:', error);
                return [];
            }
        }

        function clearSpellingAttempts() {
            try {
                localStorage.removeItem('spelldle_attempts');
                console.log('Cleared all spelling attempts');
            } catch (error) {
                console.error('Failed to clear spelling attempts:', error);
            }
        }

        /**
         * Spelling Evaluator namespace containing all evaluation functions
         */
        const SpellingEvaluator = {
            /**
             * Marks length differences between guess and target words.
             * Handles cases where guess is longer (extraneous letters) or shorter (missing letters) than target.
             * @param {number} guessLength - Length of the guess word
             * @param {number} targetLength - Length of the target word
             * @param {Object} result - Result object containing feedback, extraneous, and missing arrays
             * @private
             */
            _markLengthDifferences(guessLength, targetLength, result) {
                if (guessLength > targetLength) {
                    // Mark extra letters as extraneous
                    for (let i = targetLength; i < guessLength; i++) {
                        result.extraneous[i] = true;
                    }
                } else if (guessLength < targetLength) {
                    // Mark missing positions
                    for (let i = guessLength; i < targetLength; i++) {
                        result.feedback[i] = 'missing';
                        result.missing[i] = true;
                    }
                }
            },

            /**
             * Processes exact position matches between guess and target (green letters).
             * Only checks the overlapping portion of both words for character-by-character matches.
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @param {Object} result - Result object containing the feedback array
             * @param {boolean[]} targetUsed - Array tracking which target positions have been matched
             * @param {boolean[]} guessUsed - Array tracking which guess positions have been matched
             * @private
             */
            _processExactMatches(guess, target, result, targetUsed, guessUsed) {
                const overlapLength = Math.min(guess.length, target.length);
                
                for (let i = 0; i < overlapLength; i++) {
                    if (guess[i] === target[i]) {
                        result.feedback[i] = 'green';
                        targetUsed[i] = true;
                        guessUsed[i] = true;
                    }
                }
            },

            /**
             * Processes wrong position matches between guess and target (yellow letters).
             * Finds letters that exist in target but are in wrong positions in guess.
             * Only processes letters not already matched in exact positions.
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @param {Object} result - Result object containing the feedback array
             * @param {boolean[]} targetUsed - Array tracking which target positions have been matched
             * @param {boolean[]} guessUsed - Array tracking which guess positions have been matched
             * @private
             */
            _processWrongPositions(guess, target, result, targetUsed, guessUsed) {
                for (let i = 0; i < guess.length; i++) {
                    if (guessUsed[i]) continue; // Already matched as green
                    
                    for (let j = 0; j < target.length; j++) {
                        if (!targetUsed[j] && guess[i] === target[j]) {
                            result.feedback[i] = 'yellow';
                            targetUsed[j] = true;
                            guessUsed[i] = true;
                            break; // Only match one occurrence
                        }
                    }
                }
            },

            /**
             * Evaluates a spelling guess against a target word.
             * Returns an object with:
             *   - feedback: array of 'green', 'yellow', 'gray', or 'missing'
             *   - extraneous: array of booleans (true for extraneous letters)
             *   - missing: array of booleans (true for missing letter positions)
             * @param {string} guess - The word being guessed
             * @param {string} target - The target word to match against
             * @returns {Object} { feedback: string[], extraneous: boolean[], missing: boolean[] }
             */
            evaluate(guess, target) {
                const guessLength = guess.length;
                const targetLength = target.length;
                const maxLength = Math.max(guessLength, targetLength);
                
                // Initialize result object and tracking arrays
                const result = {
                    feedback: Array(maxLength).fill('gray'),
                    extraneous: Array(maxLength).fill(false),
                    missing: Array(maxLength).fill(false)
                };
                
                const targetUsed = Array(targetLength).fill(false);
                const guessUsed = Array(guessLength).fill(false);

                // Process evaluation in logical steps
                this._markLengthDifferences(guessLength, targetLength, result);
                this._processExactMatches(guess, target, result, targetUsed, guessUsed);
                this._processWrongPositions(guess, target, result, targetUsed, guessUsed);

                return result;
            },

            /**
             * Checks if the guess is a win (exact match: case, length, content).
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @returns {boolean} True if guess exactly matches target
             */
            isWin(guess, target) {
                return guess === target;
            }
        };

        // Check for text-to-speech support
        function checkTTSSupport() {
            if ('speechSynthesis' in window) {
                synth = window.speechSynthesis;
                ttsSupported = true;
                console.log('Text-to-speech supported');
            } else {
                ttsSupported = false;
                console.log('Text-to-speech not supported');
                showAudioFallback();
            }
        }

        // Show audio fallback message
        function showAudioFallback() {
            const fallbackDiv = document.getElementById('audioFallback');
            fallbackDiv.style.display = 'block';
        }

        // Create speech utterance with pause between word and sentence
        function createUtterance(word, sentence) {
            if (!ttsSupported) return null;
            
            // Create text with slight pause between word and sentence
            const textToSpeak = `${word}... ${sentence}`;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            // Use browser default voice at normal rate
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Handle TTS errors gracefully
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
            };
            
            return utterance;
        }

        // Speak the current word and sentence
        function speakCurrentWord() {
            if (!ttsSupported || !gameState.currentWord || !gameState.currentSentence) {
                return;
            }
            
            // Stop any current speech
            if (synth.speaking) {
                synth.cancel();
            }
            
            // Create and cache the utterance
            currentUtterance = createUtterance(gameState.currentWord, gameState.currentSentence);
            
            if (currentUtterance) {
                // Enable repeat button when speech starts
                const repeatButton = document.getElementById('repeatButton');
                repeatButton.disabled = false;
                
                synth.speak(currentUtterance);
                console.log(`Speaking: ${gameState.currentWord}... ${gameState.currentSentence}`);
            }
        }

        // Repeat the current word (replays same cached audio)
        function repeatWord() {
            if (!ttsSupported || !currentUtterance) {
                return;
            }
            
            // Stop any current speech
            if (synth.speaking) {
                synth.cancel();
            }
            
            // Replay the same cached utterance
            synth.speak(currentUtterance);
            console.log('Repeating word');
        }

        // Speak "Correct!" announcement
        function speakCorrect() {
            if (!ttsSupported) return;
            
            const correctUtterance = new SpeechSynthesisUtterance('Correct!');
            correctUtterance.rate = 1.0;
            correctUtterance.pitch = 1.0;
            correctUtterance.volume = 1.0;
            
            correctUtterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
            };
            
            if (synth.speaking) {
                synth.cancel();
            }
            
            synth.speak(correctUtterance);
        }

        // Create realistic confetti effect using canvas-confetti
        function createRealisticConfetti() {
            if (typeof confetti === 'undefined') {
                console.warn('Canvas confetti library not loaded');
                return;
            }

            const count = 200;
            const defaults = {
                origin: { y: 0.7 },
                colors: ['#6aaa64', '#5a9fd4'] // Using existing green and blue colors
            };

            function fire(particleRatio, opts) {
                confetti({
                    ...defaults,
                    ...opts,
                    particleCount: Math.floor(count * particleRatio)
                });
            }

            // Multiple bursts with different characteristics for realistic effect
            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });

            fire(0.2, {
                spread: 60,
            });

            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
        }

        // Speak reinforcement announcement with spelling
        function speakReinforcementAnnouncement() {
            if (!ttsSupported || !gameState.currentWord) return;
            
            // Create spelled-out version of the word
            const spelledWord = gameState.currentWord.split('').join(' ').toUpperCase();
            const announcement = `Correct! ${gameState.currentWord} is spelled ${spelledWord}. Practice typing it one more time.`;
            
            const utterance = new SpeechSynthesisUtterance(announcement);
            utterance.rate = 0.9; // Slightly slower for clarity
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
            };
            
            if (synth.speaking) {
                synth.cancel();
            }
            
            synth.speak(utterance);
            console.log(`Speaking reinforcement: ${announcement}`);
        }

        // Handle input field keydown events
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitGuess();
            }
        }

        // Handle input changes for case handling
        function handleInputChange(event) {
            // Clear any validation messages when user starts typing
            clearValidationMessage();
        }

        // Show validation message
        function showValidationMessage(message) {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = message;
        }

        // Clear validation message
        function clearValidationMessage() {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = '';
        }

        // Submit the current guess
        function submitGuess() {
            const input = document.getElementById('guessInput');
            const guess = input.value.trim();
            
            // Prevent empty submissions
            if (!guess) {
                showValidationMessage('Please enter a guess before submitting.');
                input.focus();
                return;
            }
            
            clearValidationMessage();
            console.log(`User guessed: "${guess}" for target: "${gameState.currentWord}"`);
            
            // Case-sensitive word comparison
            if (guess === gameState.currentWord) {
                // Correct guess - play "Correct!" and advance to next word
                handleCorrectGuess();
            } else {
                // Incorrect guess - transition to Clue Phase
                handleIncorrectGuess(guess);
            }
        }

        // Handle correct guess
        function handleCorrectGuess() {
            console.log('Correct guess!');
            
            // Get the current guess from input
            const input = document.getElementById('guessInput');
            const guess = input ? input.value.trim() : gameState.currentWord;
            
            // Save spelling attempt to localStorage
            saveSpellingAttempt(guess, true);
            
            // Track the guess for lesson stats
            trackGuess(true);
            
            // Disable input during transition
            disableInputs();
            
            // Check if user had incorrect guess - if so, go to reinforcement phase
            if (gameState.hadIncorrectGuess) {
                // Play "Correct!" and transition to reinforcement phase
                speakCorrect();
                setTimeout(() => {
                    showReinforcementPhase();
                }, 1500);
            } else {
                // Direct correct guess on first try - show confetti, play "Correct!", and advance
                createRealisticConfetti();
                speakCorrect();
                setTimeout(() => {
                    advanceToNextWord();
                }, 1500);
            }
        }

        // Handle incorrect guess
        function handleIncorrectGuess(guess) {
            console.log(`Incorrect guess: "${guess}"`);
            
            // Mark that user had an incorrect guess
            gameState.hadIncorrectGuess = true;
            
            // Save spelling attempt to localStorage
            saveSpellingAttempt(guess, false);
            
            // Track the guess for lesson stats
            trackGuess(false);
            
            // Transition to Clue Phase (don't clear screen)
            gameState.currentPhase = 'clue';
            
            // Hide the initial guess input
            hideInitialGuessInput();
            
            // Show clue phase feedback
            showCluePhase(guess);
        }

        // Clear and focus the input field
        function clearAndFocusInput() {
            const input = document.getElementById('guessInput');
            input.value = '';
            clearValidationMessage();
            input.focus();
        }

        // Show the initial guess input
        function showInitialGuessInput() {
            const container = document.getElementById('initialGuessContainer');
            container.style.display = 'flex';
            
            // Enable inputs and focus the input field after a brief delay
            setTimeout(() => {
                enableInputs();
                clearAndFocusInput();
            }, 100);
        }

        // Hide the initial guess input
        function hideInitialGuessInput() {
            const container = document.getElementById('initialGuessContainer');
            container.style.display = 'none';
        }

        // Render feedback boxes from SpellingEvaluator results
        function renderFeedbackBoxes(guess, target, evaluation) {
            const { feedback, extraneous, missing } = evaluation;
            const boxes = [];
            
            for (let i = 0; i < feedback.length; i++) {
                const letter = missing[i] ? '' : (guess[i] || '');
                const colorClass = feedback[i];
                const extraneousClass = extraneous[i] ? ' extraneous' : '';
                const missingClass = missing[i] ? ' missing' : '';
                
                boxes.push(`<div class="letter-box ${colorClass}${extraneousClass}${missingClass}">${letter}</div>`);
            }
            
            return boxes.join('');
        }

        // Show the clue phase with feedback
        function showCluePhase(guess) {
            const container = document.getElementById('cluePhaseContainer');
            container.style.display = 'flex';
            
            // Create wrapper for feedback rows if it doesn't exist
            let wrapper = container.querySelector('.feedback-rows-wrapper');
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.className = 'feedback-rows-wrapper';
                container.appendChild(wrapper);
            }
            
            // Evaluate the guess using SpellingEvaluator
            const evaluation = SpellingEvaluator.evaluate(guess, gameState.currentWord);
            console.log('Evaluation result:', evaluation);
            
            // Create feedback row
            const feedbackRow = document.createElement('div');
            feedbackRow.className = 'feedback-row';
            feedbackRow.innerHTML = renderFeedbackBoxes(guess, gameState.currentWord, evaluation);
            
            // Add the feedback row to the wrapper
            wrapper.appendChild(feedbackRow);
            
            // Add input row for next guess
            addInputRow(wrapper);
            
            console.log(`Displayed feedback for guess: "${guess}" vs target: "${gameState.currentWord}"`);
        }

        // Add input row with individual letter boxes
        function addInputRow(wrapper) {
            const inputRowContainer = document.createElement('div');
            inputRowContainer.className = 'input-row-container';
            
            // Create input row
            const inputRow = document.createElement('div');
            inputRow.className = 'input-row-clue';
            
            // Create individual input fields for each letter in target word
            for (let i = 0; i < gameState.currentWord.length; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'letter-input';
                input.maxLength = 1;
                input.value = ''; // Ensure input starts empty
                input.dataset.index = i;
                input.addEventListener('input', handleLetterInput);
                input.addEventListener('keydown', handleLetterKeydown);
                inputRow.appendChild(input);
            }
            
            inputRowContainer.appendChild(inputRow);
            
            // Create submit button
            const submitButton = document.createElement('button');
            submitButton.className = 'clue-submit-button';
            submitButton.textContent = 'Submit';
            submitButton.onclick = submitClueGuess;
            inputRowContainer.appendChild(submitButton);
            
            wrapper.appendChild(inputRowContainer);
            
            // Auto-focus first input box after a brief delay
            const firstInput = inputRow.querySelector('.letter-input');
            if (firstInput) {
                setTimeout(() => {
                    firstInput.focus();
                    firstInput.select(); // Ensure any existing content is selected
                }, 150);
            }
        }

        // Handle input in letter boxes
        function handleLetterInput(event) {
            const input = event.target;
            let value = input.value;
            
            // Only keep the last character if multiple were entered
            if (value.length > 1) {
                value = value.slice(-1);
                input.value = value;
            }
            
            // Move to next box if letter was entered
            if (value) {
                const currentIndex = parseInt(input.dataset.index);
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select(); // Select any existing content
                }
            }
        }

        // Handle keydown events in letter boxes
        function handleLetterKeydown(event) {
            const input = event.target;
            const currentIndex = parseInt(input.dataset.index);
            
            if (event.key === 'Backspace') {
                // If current box is empty, move to previous box and clear it
                if (!input.value && currentIndex > 0) {
                    const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.select(); // Select content for easy replacement
                    }
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                submitClueGuess();
            } else if (event.key === 'ArrowLeft' && currentIndex > 0) {
                const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                if (prevInput) {
                    prevInput.focus();
                    prevInput.select();
                }
            } else if (event.key === 'ArrowRight' && currentIndex < gameState.currentWord.length - 1) {
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }

        // Submit clue phase guess
        function submitClueGuess() {
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            const lastInputRow = wrapper.querySelector('.input-row-container:last-child .input-row-clue');
            const inputs = lastInputRow.querySelectorAll('.letter-input');
            
            // Collect letters from input boxes
            let guess = '';
            let allFilled = true;
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (!value) {
                    allFilled = false;
                }
                guess += value;
            });
            
            // Prevent submission if not all boxes are filled
            if (!allFilled) {
                // Find first empty input and focus it
                const firstEmpty = Array.from(inputs).find(input => !input.value.trim());
                if (firstEmpty) {
                    firstEmpty.focus();
                }
                return;
            }
            
            console.log(`Clue phase guess: "${guess}" for target: "${gameState.currentWord}"`);
            
            // Check if guess is correct
            if (guess === gameState.currentWord) {
                // Save correct spelling attempt to localStorage
                saveSpellingAttempt(guess, true);
                // Track the guess for lesson stats
                trackGuess(true);
                // Disable inputs during transition
                disableInputs();
                
                // Show green feedback for correct guess
                showCorrectGuessFeedback(guess);
                
                // Show reinforcement phase immediately
                showReinforcementPhase();
                
                // Start TTS announcement in parallel
                speakReinforcementAnnouncement();
            } else {
                // Incorrect guess - add new feedback row and input row
                handleIncorrectClueGuess(guess);
            }
        }

        // Handle incorrect guess in clue phase
        function handleIncorrectClueGuess(guess) {
            console.log(`Incorrect clue guess: "${guess}"`);
            
            // Save spelling attempt to localStorage
            saveSpellingAttempt(guess, false);
            
            // Track the guess for lesson stats
            trackGuess(false);
            
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            
            // Remove the current input row before adding feedback
            const currentInputContainer = wrapper.querySelector('.input-row-container:last-child');
            if (currentInputContainer) {
                currentInputContainer.remove();
            }
            
            // Evaluate the guess using SpellingEvaluator
            const evaluation = SpellingEvaluator.evaluate(guess, gameState.currentWord);
            console.log('Clue evaluation result:', evaluation);
            
            // Create new feedback row
            const feedbackRow = document.createElement('div');
            feedbackRow.className = 'feedback-row';
            feedbackRow.innerHTML = renderFeedbackBoxes(guess, gameState.currentWord, evaluation);
            
            // Add the feedback row to the wrapper
            wrapper.appendChild(feedbackRow);
            
            // Add new input row for next attempt with cleared boxes
            addInputRow(wrapper);
        }

        // Disable inputs during transitions
        function disableInputs() {
            const guessInput = document.getElementById('guessInput');
            const submitButton = document.getElementById('submitButton');
            const clueInputs = document.querySelectorAll('.letter-input');
            const clueSubmitButtons = document.querySelectorAll('.clue-submit-button');
            
            if (guessInput) guessInput.disabled = true;
            if (submitButton) submitButton.disabled = true;
            clueInputs.forEach(input => input.disabled = true);
            clueSubmitButtons.forEach(button => button.disabled = true);
        }

        // Enable inputs after transitions
        function enableInputs() {
            const guessInput = document.getElementById('guessInput');
            const submitButton = document.getElementById('submitButton');
            const clueInputs = document.querySelectorAll('.letter-input');
            const clueSubmitButtons = document.querySelectorAll('.clue-submit-button');
            
            if (guessInput) guessInput.disabled = false;
            if (submitButton) submitButton.disabled = false;
            clueInputs.forEach(input => input.disabled = false);
            clueSubmitButtons.forEach(button => button.disabled = false);
        }

        // Hide the clue phase
        function hideCluePhase() {
            const container = document.getElementById('cluePhaseContainer');
            container.style.display = 'none';
            // Clear all feedback rows
            container.innerHTML = '';
        }

        // Show correct guess feedback (all green boxes)
        function showCorrectGuessFeedback(guess) {
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            
            // Remove the current input row before adding feedback
            const currentInputContainer = wrapper.querySelector('.input-row-container:last-child');
            if (currentInputContainer) {
                currentInputContainer.remove();
            }
            
            // Create feedback row with all green boxes
            const feedbackRow = document.createElement('div');
            feedbackRow.className = 'feedback-row';
            
            // Create all green boxes for correct guess
            const boxes = [];
            for (let i = 0; i < guess.length; i++) {
                boxes.push(`<div class="letter-box green">${guess[i]}</div>`);
            }
            feedbackRow.innerHTML = boxes.join('');
            
            // Add the feedback row to the wrapper
            wrapper.appendChild(feedbackRow);
        }

        // Show reinforcement phase
        function showReinforcementPhase() {
            console.log('Showing reinforcement phase');
            gameState.currentPhase = 'reinforcement';
            
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            
            // Add reinforcement input row that aligns with previous rows
            addReinforcementInputRow(wrapper);
        }

        // Add reinforcement input row with individual letter boxes
        function addReinforcementInputRow(wrapper) {
            const inputRowContainer = document.createElement('div');
            inputRowContainer.className = 'input-row-container reinforcement-container';
            
            // Create input row
            const inputRow = document.createElement('div');
            inputRow.className = 'reinforcement-input-row';
            
            // Create individual input fields for each letter in target word
            for (let i = 0; i < gameState.currentWord.length; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'letter-input';
                input.maxLength = 1;
                input.value = '';
                input.dataset.index = i;
                input.addEventListener('input', handleReinforcementLetterInput);
                input.addEventListener('keydown', handleReinforcementLetterKeydown);
                inputRow.appendChild(input);
            }
            
            inputRowContainer.appendChild(inputRow);
            
            // Create submit button
            const submitButton = document.createElement('button');
            submitButton.className = 'reinforcement-submit-button';
            submitButton.textContent = 'Continue';
            submitButton.onclick = submitReinforcementGuess;
            inputRowContainer.appendChild(submitButton);
            
            wrapper.appendChild(inputRowContainer);
            
            // Auto-focus first input box after a brief delay
            const firstInput = inputRow.querySelector('.letter-input');
            if (firstInput) {
                setTimeout(() => {
                    firstInput.focus();
                }, 200);
            }
        }

        // Handle input in reinforcement letter boxes
        function handleReinforcementLetterInput(event) {
            const input = event.target;
            let value = input.value;
            
            // Only keep the last character if multiple were entered
            if (value.length > 1) {
                value = value.slice(-1);
                input.value = value;
            }
            
            // Move to next box if letter was entered
            if (value) {
                const currentIndex = parseInt(input.dataset.index);
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }

        // Handle keydown events in reinforcement letter boxes
        function handleReinforcementLetterKeydown(event) {
            const input = event.target;
            const currentIndex = parseInt(input.dataset.index);
            
            if (event.key === 'Backspace') {
                // If current box is empty, move to previous box and clear it
                if (!input.value && currentIndex > 0) {
                    const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.select();
                    }
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                submitReinforcementGuess();
            } else if (event.key === 'ArrowLeft' && currentIndex > 0) {
                const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                if (prevInput) {
                    prevInput.focus();
                    prevInput.select();
                }
            } else if (event.key === 'ArrowRight' && currentIndex < gameState.currentWord.length - 1) {
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }

        // Submit reinforcement guess
        function submitReinforcementGuess() {
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            const reinforcementContainer = wrapper.querySelector('.reinforcement-container');
            const inputRow = reinforcementContainer.querySelector('.reinforcement-input-row');
            const inputs = inputRow.querySelectorAll('.letter-input');
            
            // Collect letters from input boxes
            let guess = '';
            let allFilled = true;
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (!value) {
                    allFilled = false;
                }
                guess += value;
            });
            
            // Prevent submission if not all boxes are filled
            if (!allFilled) {
                // Find first empty input and focus it
                const firstEmpty = Array.from(inputs).find(input => !input.value.trim());
                if (firstEmpty) {
                    firstEmpty.focus();
                }
                return;
            }
            
            // Only accept correctly spelled word
            if (guess !== gameState.currentWord) {
                // Flash the submit button or show some indication
                const submitButton = reinforcementContainer.querySelector('.reinforcement-submit-button');
                const originalColor = submitButton.style.backgroundColor;
                submitButton.style.backgroundColor = '#d73a49';
                setTimeout(() => {
                    submitButton.style.backgroundColor = originalColor;
                }, 300);
                
                // Focus first input to try again
                const firstInput = inputs[0];
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
                return;
            }
            
            console.log(`Reinforcement guess: "${guess}" for target: "${gameState.currentWord}"`);
            
            // Advance to next word after reinforcement
            setTimeout(() => {
                advanceToNextWord();
            }, 500);
        }

        // Get current word data (updated for lessons)
        function getCurrentWordData() {
            if (gameState.currentLessonWords.length > 0) {
                if (gameState.currentWordIndex < gameState.currentLessonWords.length) {
                    const row = gameState.currentLessonWords[gameState.currentWordIndex];
                    return { word: row.word, sentence: row.sentence };
                }
            } else {
                // Fallback to hardcoded words
                if (gameState.currentWordIndex < fallbackWordList.length) {
                    return fallbackWordList[gameState.currentWordIndex];
                }
            }
            return null;
        }

        // Update progress counter display
        function updateProgressCounter() {
            const progressCounter = document.getElementById('progressCounter');
            if (gameState.currentLesson) {
                progressCounter.textContent = `${gameState.currentLesson} - Word ${gameState.currentWordIndex + 1} of ${gameState.totalWords}`;
            } else {
                progressCounter.textContent = `Word ${gameState.currentWordIndex + 1} of ${gameState.totalWords}`;
            }
            progressCounter.style.display = 'block';
        }

        // Advance to next word
        function advanceToNextWord() {
            gameState.currentWordIndex++;
            if (gameState.currentWordIndex < gameState.totalWords) {
                // Reset to Initial Guess Phase for new word
                gameState.currentPhase = 'initial';
                gameState.hadIncorrectGuess = false; // Reset for new word
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    updateProgressCounter();
                    
                    // Hide clue phase and show initial guess input for new word
                    hideCluePhase();
                    showInitialGuessInput();
                    
                    // Auto-play the new word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500); // Brief delay before speaking
                    
                    console.log(`Advanced to word ${gameState.currentWordIndex + 1}: ${gameState.currentWord}`);
                } else {
                    console.error('Failed to get word data for index:', gameState.currentWordIndex);
                    handleGameCompletion();
                }
            } else {
                // Handle game completion (after word 12)
                handleGameCompletion();
            }
        }

        // Updated game completion handler
        function handleGameCompletion() {
            if (gameState.currentLesson) {
                handleLessonCompletion();
            } else {
                // Original game complete behavior
                console.log('Game completed!');
                hideInitialGuessInput();
                hideCluePhase();
                const gameCompleteContainer = document.getElementById('gameCompleteContainer');
                gameCompleteContainer.style.display = 'flex';
            }
        }

        // Play again functionality
        function playAgain() {
            console.log('Starting new game');
            
            try {
                // Reset game state to word 1
                gameState.currentWordIndex = 0;
                gameState.currentPhase = 'initial';
                gameState.gameStarted = true;
                gameState.hadIncorrectGuess = false;
                
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    
                    // Update progress counter
                    updateProgressCounter();
                    
                    // Hide game complete container and clue phase
                    const gameCompleteContainer = document.getElementById('gameCompleteContainer');
                    gameCompleteContainer.style.display = 'none';
                    hideCluePhase();
                    
                    // Clear any validation messages
                    clearValidationMessage();
                    
                    // Show initial guess input
                    showInitialGuessInput();
                    
                    // Auto-play the first word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500);
                } else {
                    console.error('Failed to reset game - no word data available');
                }
            } catch (error) {
                console.error('Error during game reset:', error);
            }
        }

        // Initialize the game
        function initializeGame() {
            try {
                gameState.gameStarted = true;
                gameState.currentWordIndex = 0;
                gameState.currentPhase = 'initial';
                
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    
                    updateProgressCounter();
                    
                    // Hide welcome screen and start button
                    const welcomeScreen = document.getElementById('welcomeScreen');
                    if (welcomeScreen) welcomeScreen.style.display = 'none';
                    
                    const startButton = document.getElementById('startButton');
                    startButton.style.display = 'none';
                    
                    const audioControls = document.getElementById('audioControls');
                    audioControls.style.display = 'flex';
                    
                    // Show initial guess input
                    showInitialGuessInput();
                    
                    // Auto-play the first word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500); // Brief delay to let UI update
                    
                    console.log('Game initialized');
                    console.log(`Current word: ${gameState.currentWord}`);
                    console.log(`Current sentence: ${gameState.currentSentence}`);
                } else {
                    console.error('Failed to initialize game - no word data available');
                }
            } catch (error) {
                console.error('Error during game initialization:', error);
            }
        }

        // Initialize the page when it loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Spelldle initialized');
                console.log('Current game state:', gameState);
                checkTTSSupport();
                
                // Initialize lessons
                initializeLessons();
                
                // Validate fallback word list
                if (fallbackWordList.length !== 12) {
                    console.warn(`Expected 12 fallback words, found ${fallbackWordList.length}`);
                }
                
                // Validate each fallback word entry
                fallbackWordList.forEach((entry, index) => {
                    if (!entry.word || !entry.sentence) {
                        console.error(`Invalid fallback word entry at index ${index}:`, entry);
                    }
                });
                
                // Test SpellingEvaluator integration (only in development)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('Testing SpellingEvaluator integration:');
                    const testResult = SpellingEvaluator.evaluate('hello', 'world');
                    console.log('SpellingEvaluator.evaluate("hello", "world"):', testResult);
                    console.log('SpellingEvaluator.isWin("friend", "friend"):', SpellingEvaluator.isWin('friend', 'friend'));
                    console.log('SpellingEvaluator.isWin("friend", "fiend"):', SpellingEvaluator.isWin('friend', 'fiend'));
                    
                    // Test localStorage functions
                    console.log('Testing localStorage functions:');
                    console.log('Current attempts count:', getSpellingAttempts().length);
                }
            } catch (error) {
                console.error('Error during page initialization:', error);
            }
        });
    </script>
</body>
</html>
