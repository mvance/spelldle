<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelldle</title>
    <!-- Papa Parse CDN -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color scheme variables */
        :root {
            --green: #6aaa64;
            --yellow: #c9b458;
            --gray: #787c7e;
            --blue: #5a9fd4;
            --dark-bg: #121213;
            --dark-text: #ffffff;
            --dark-border: #3a3a3c;
        }

        /* Dark theme styling */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* Progress counter styling */
        .progress-counter {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Main game container */
        .game-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Start button styling */
        .start-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .start-button:hover {
            background-color: #4a8fc4;
        }

        .start-button:active {
            background-color: #3a7fb4;
        }

        /* Audio controls styling */
        .audio-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .repeat-button {
            background-color: var(--gray);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .repeat-button:hover {
            background-color: #686c6f;
        }

        .repeat-button:active {
            background-color: #585c5f;
        }

        .repeat-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .audio-fallback {
            background-color: #444;
            color: var(--yellow);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            margin: 10px 0;
        }

        /* Initial guess input styling */
        .initial-guess-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .guess-input {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 6px;
            min-width: 200px;
            text-align: center;
            font-family: inherit;
        }

        .guess-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .submit-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .submit-button:hover {
            background-color: #4a8fc4;
        }

        .submit-button:active {
            background-color: #3a7fb4;
        }

        .submit-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .validation-message {
            color: var(--yellow);
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }

        /* Game completion styling */
        .game-complete-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .game-complete-message {
            font-size: 24px;
            font-weight: bold;
            color: var(--blue);
        }

        .play-again-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .play-again-button:hover {
            background-color: #4a8fc4;
        }

        .play-again-button:active {
            background-color: #3a7fb4;
        }

        /* Clue phase feedback styling */
        .clue-phase-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }

        .feedback-rows-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .feedback-row {
            display: flex;
            gap: 5px;
            justify-content: flex-start;
            margin: 5px 0;
        }

        .letter-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: 3px solid #d3d6da;
            border-radius: 3px;
            font-weight: bold;
            font-size: 18px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .letter-box.green {
            background-color: var(--green);
            color: white;
        }

        .letter-box.yellow {
            background-color: var(--yellow);
            color: white;
        }

        .letter-box.gray {
            background-color: var(--gray);
            color: white;
        }

        .letter-box.extraneous {
            border: 3px dotted #d3d6da;
        }

        .letter-box.missing {
            background-color: transparent;
            border: 3px solid #d3d6da;
            color: var(--dark-text);
        }

        /* Clue phase input styling */
        .input-row-clue {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
        }

        .letter-input {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: 3px solid #d3d6da;
            border-radius: 3px;
            font-weight: bold;
            font-size: 18px;
            text-transform: lowercase;
            box-sizing: border-box;
            text-align: center;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            font-family: inherit;
        }

        .letter-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .clue-submit-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .clue-submit-button:hover {
            background-color: #4a8fc4;
        }

        .clue-submit-button:active {
            background-color: #3a7fb4;
        }

        .clue-submit-button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .game-container {
                max-width: 100%;
                padding: 15px;
            }
            
            .progress-counter {
                font-size: 16px;
                margin-bottom: 20px;
            }
            
            .letter-box, .letter-input {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .feedback-row, .input-row-clue {
                gap: 3px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            .letter-box, .letter-input {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .feedback-row, .input-row-clue {
                gap: 2px;
            }
            
            .guess-input {
                min-width: 150px;
                font-size: 14px;
            }
            
            .submit-button, .clue-submit-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        /* Welcome screen styling */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .welcome-screen h1 {
            font-size: 48px;
            font-weight: bold;
            color: var(--blue);
            margin: 0;
        }

        .lesson-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .lesson-selector label {
            font-size: 18px;
            font-weight: bold;
        }

        .lesson-dropdown {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 6px;
            min-width: 250px;
            font-family: inherit;
        }

        .lesson-dropdown:focus {
            outline: none;
            border-color: var(--blue);
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            color: var(--blue);
            margin-bottom: 20px;
        }

        .lesson-stats {
            margin: 20px 0;
            font-size: 16px;
            line-height: 1.8;
        }

        .lesson-navigation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #4a8fc4;
        }

        .modal-button:active {
            background-color: #3a7fb4;
        }

        .error-details {
            background-color: #2a2a2a;
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 320px) {
            .letter-box, .letter-input {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
            
            .guess-input {
                min-width: 120px;
            }
            
            .welcome-screen h1 {
                font-size: 36px;
            }
            
            .lesson-dropdown {
                min-width: 200px;
                font-size: 14px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="progress-counter" id="progressCounter" style="display: none;">Word 1 of 12</div>
    
    <div class="game-container" id="gameContainer">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen" style="display: flex;">
            <h1>Spelldle</h1>
            <div class="lesson-selector" id="lessonSelector">
                <label for="lessonDropdown">Choose a lesson:</label>
                <select id="lessonDropdown" class="lesson-dropdown">
                    <option value="">Loading lessons...</option>
                </select>
                <button class="start-button" id="startLessonButton" onclick="startSelectedLesson()" disabled>Start Lesson</button>
            </div>
        </div>
        
        <button class="start-button" id="startButton" onclick="initializeGame()" style="display: none;">Start Game</button>
        <div class="audio-controls" id="audioControls" style="display: none;">
            <button class="repeat-button" id="repeatButton" onclick="repeatWord()" disabled>Repeat Word</button>
        </div>
        <div class="audio-fallback" id="audioFallback" style="display: none;">
            Audio not supported in this browser
        </div>
        
        <div class="initial-guess-container" id="initialGuessContainer" style="display: none;">
            <div class="input-row">
                <input 
                    type="text" 
                    class="guess-input" 
                    id="guessInput" 
                    placeholder="Type your guess..."
                    spellcheck="false"
                    autocomplete="off"
                    onkeydown="handleInputKeydown(event)"
                    oninput="handleInputChange(event)"
                />
                <button class="submit-button" id="submitButton" onclick="submitGuess()">Submit</button>
            </div>
            <div class="validation-message" id="validationMessage"></div>
        </div>
        
        <div class="clue-phase-container" id="cluePhaseContainer" style="display: none;">
            <!-- Feedback rows will be dynamically added here -->
        </div>
        
        <div class="game-complete-container" id="gameCompleteContainer" style="display: none;">
            <div class="game-complete-message">Game Complete!</div>
            <button class="play-again-button" onclick="playAgain()">Play Again</button>
        </div>
        
        <!-- Lesson Complete Modal -->
        <div class="modal-overlay" id="lessonCompleteModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Complete!</h2>
                <div class="lesson-stats" id="lessonStats"></div>
                <div class="lesson-navigation">
                    <select id="nextActionDropdown" class="lesson-dropdown">
                        <option value="next">Next Lesson</option>
                        <option value="menu">Return to Menu</option>
                    </select>
                    <button class="modal-button" onclick="handleLessonComplete()">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div class="modal-overlay" id="errorModal" style="display: none;">
            <div class="modal-content">
                <h2>Lesson Load Error</h2>
                <div class="error-details" id="errorDetails"></div>
                <button class="modal-button" onclick="retryLessonLoad()">Retry</button>
            </div>
        </div>
    </div>

    <script>
        // CSV data URL
        const CSV_URL = 'https://gist.githubusercontent.com/mvance/1096921b2243372780ccef1d82f1a156/raw/';
        const CSV_TIMEOUT = 20000; // 20 seconds

        // Lesson data
        let lessonsData = [];
        let availableLessons = [];
        
        // Fallback word list (original hardcoded words)
        const fallbackWordList = [
            { word: "friend", sentence: "She is my best friend." },
            { word: "bright", sentence: "The sun is very bright today." },
            { word: "school", sentence: "I walk to school every morning." },
            { word: "enough", sentence: "We have enough food for dinner." },
            { word: "through", sentence: "The ball went through the window." },
            { word: "because", sentence: "I stayed home because I was sick." },
            { word: "different", sentence: "Each snowflake is different." },
            { word: "beautiful", sentence: "The sunset was beautiful tonight." },
            { word: "important", sentence: "It's important to brush your teeth." },
            { word: "knowledge", sentence: "Reading books increases your knowledge." },
            { word: "rhythm", sentence: "The music has a steady rhythm." },
            { word: "necessary", sentence: "Sleep is necessary for good health." }
        ];

        // Game state variables
        const gameState = {
            currentWordIndex: 0,
            currentPhase: 'initial', // 'initial' or 'clue'
            totalWords: 0,
            currentWord: null,
            currentSentence: null,
            gameStarted: false,
            currentLesson: null,
            currentLessonWords: [],
            correctGuesses: 0,
            totalGuesses: 0,
            lessonStartTime: null
        };

        // Text-to-speech variables
        let ttsSupported = false;
        let currentUtterance = null;
        let synth = null;

        // Fetch and parse CSV lessons
        async function loadLessons() {
            try {
                console.log('Loading lessons from CSV...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CSV_TIMEOUT);
                
                const response = await fetch(CSV_URL, {
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                reject(new Error(`CSV Parse Error: ${results.errors.map(e => e.message).join(', ')}`));
                                return;
                            }
                            
                            // Map CSV headers to expected format
                            const headers = results.meta.fields || [];
                            
                            // Check if we have the expected headers (with flexible naming)
                            const hasLessonName = headers.includes('Lesson Name') || headers.includes('lesson_name');
                            const hasWord = headers.includes('Word') || headers.includes('word');
                            const hasSentence = headers.includes('Example Sentence') || headers.includes('sentence');
                            
                            if (!hasLessonName || !hasWord || !hasSentence) {
                                reject(new Error(`Missing required columns. Found: ${headers.join(', ')}`));
                                return;
                            }
                            
                            // Normalize the data to use consistent field names
                            lessonsData = results.data.map(row => ({
                                lesson_name: row['Lesson Name'] || row['lesson_name'],
                                word: row['Word'] || row['word'],
                                sentence: row['Example Sentence'] || row['sentence']
                            })).filter(row => row.lesson_name && row.word && row.sentence);
                            
                            // Clean up any problematic entries (filter out entries with spaces in word field)
                            lessonsData = lessonsData.filter(row => {
                                if (row.word.includes(' ') && row.word.trim() !== row.word) {
                                    console.warn(`Skipping problematic word entry: "${row.word}"`);
                                    return false;
                                }
                                return true;
                            });
                            
                            availableLessons = [...new Set(lessonsData.map(row => row.lesson_name))].filter(Boolean);
                            
                            console.log(`Loaded ${lessonsData.length} words across ${availableLessons.length} lessons`);
                            console.log('Available lessons:', availableLessons);
                            resolve();
                        },
                        error: function(error) {
                            reject(new Error(`Papa Parse Error: ${error.message}`));
                        }
                    });
                });
                
            } catch (error) {
                console.error('Failed to load lessons:', error);
                throw error;
            }
        }

        // Show error modal with detailed information
        function showErrorModal(error, response = null) {
            const modal = document.getElementById('errorModal');
            const details = document.getElementById('errorDetails');
            
            const errorInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: CSV_URL,
                error: error.message,
                stack: error.stack
            };
            
            if (response) {
                errorInfo.httpStatus = response.status;
                errorInfo.httpStatusText = response.statusText;
                errorInfo.responseHeaders = Object.fromEntries(response.headers.entries());
            }
            
            details.textContent = JSON.stringify(errorInfo, null, 2);
            modal.style.display = 'flex';
            
            // Disable all controls
            disableAllControls();
        }

        // Disable all game controls
        function disableAllControls() {
            const controls = document.querySelectorAll('button, input, select');
            controls.forEach(control => {
                if (!control.onclick || control.onclick.toString().indexOf('retryLessonLoad') === -1) {
                    control.disabled = true;
                }
            });
        }

        // Enable all game controls
        function enableAllControls() {
            const controls = document.querySelectorAll('button, input, select');
            controls.forEach(control => control.disabled = false);
        }

        // Retry lesson loading
        async function retryLessonLoad() {
            const modal = document.getElementById('errorModal');
            modal.style.display = 'none';
            enableAllControls();
            await initializeLessons();
        }

        // Populate lesson dropdown
        function populateLessonDropdown() {
            const dropdown = document.getElementById('lessonDropdown');
            const startButton = document.getElementById('startLessonButton');
            
            dropdown.innerHTML = '<option value="">Select a lesson...</option>';
            
            availableLessons.forEach(lessonName => {
                const option = document.createElement('option');
                option.value = lessonName;
                option.textContent = lessonName;
                dropdown.appendChild(option);
            });
            
            // Remove any existing event listeners and add new one
            dropdown.removeEventListener('change', handleLessonDropdownChange);
            dropdown.addEventListener('change', handleLessonDropdownChange);
            
            startButton.disabled = true;
        }

        // Handle lesson dropdown change
        function handleLessonDropdownChange() {
            const dropdown = document.getElementById('lessonDropdown');
            const startButton = document.getElementById('startLessonButton');
            startButton.disabled = !dropdown.value;
        }

        // Show fallback when lessons fail to load
        function showLessonLoadFallback() {
            const dropdown = document.getElementById('lessonDropdown');
            dropdown.innerHTML = '<option value="">Failed to load lessons</option>';
            
            // Add fallback option to use original word list
            const fallbackOption = document.createElement('option');
            fallbackOption.value = 'fallback';
            fallbackOption.textContent = 'Original Word List (Fallback)';
            dropdown.appendChild(fallbackOption);
            
            dropdown.addEventListener('change', function() {
                const startButton = document.getElementById('startLessonButton');
                startButton.disabled = !this.value;
                if (this.value === 'fallback') {
                    startButton.textContent = 'Start Game';
                } else {
                    startButton.textContent = 'Start Lesson';
                }
            });
        }

        // Start selected lesson
        function startSelectedLesson() {
            const dropdown = document.getElementById('lessonDropdown');
            const selectedLesson = dropdown.value;
            
            if (!selectedLesson) return;
            
            if (selectedLesson === 'fallback') {
                // Use fallback word list
                gameState.currentLesson = null;
                gameState.currentLessonWords = [];
                gameState.totalWords = fallbackWordList.length;
                gameState.currentWordIndex = 0;
                gameState.correctGuesses = 0;
                gameState.totalGuesses = 0;
                gameState.lessonStartTime = Date.now();
                
                console.log('Starting fallback game with original word list');
            } else {
                // Filter words for selected lesson
                gameState.currentLesson = selectedLesson;
                gameState.currentLessonWords = lessonsData.filter(row => row.lesson_name === selectedLesson);
                gameState.totalWords = gameState.currentLessonWords.length;
                gameState.currentWordIndex = 0;
                gameState.correctGuesses = 0;
                gameState.totalGuesses = 0;
                gameState.lessonStartTime = Date.now();
                
                console.log(`Starting lesson: ${selectedLesson} with ${gameState.totalWords} words`);
            }
            
            // Hide welcome screen and start game
            document.getElementById('welcomeScreen').style.display = 'none';
            initializeGame();
        }

        // Handle lesson completion
        function handleLessonCompletion() {
            console.log('Lesson completed!');
            
            // Calculate stats
            const accuracy = gameState.totalGuesses > 0 ? Math.round((gameState.correctGuesses / gameState.totalGuesses) * 100) : 0;
            const duration = Math.round((Date.now() - gameState.lessonStartTime) / 1000);
            
            // Hide game elements
            hideInitialGuessInput();
            hideCluePhase();
            
            // Show lesson complete modal
            const modal = document.getElementById('lessonCompleteModal');
            const stats = document.getElementById('lessonStats');
            const dropdown = document.getElementById('nextActionDropdown');
            
            stats.innerHTML = `
                <div><strong>Lesson:</strong> ${gameState.currentLesson}</div>
                <div><strong>Words:</strong> ${gameState.totalWords}</div>
                <div><strong>Accuracy:</strong> ${accuracy}% (${gameState.correctGuesses}/${gameState.totalGuesses})</div>
                <div><strong>Time:</strong> ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}</div>
            `;
            
            // Check if there's a next lesson
            const currentLessonIndex = availableLessons.indexOf(gameState.currentLesson);
            const hasNextLesson = currentLessonIndex < availableLessons.length - 1;
            
            dropdown.innerHTML = '';
            if (hasNextLesson) {
                const nextLesson = availableLessons[currentLessonIndex + 1];
                dropdown.innerHTML += `<option value="next">Next Lesson: ${nextLesson}</option>`;
            }
            dropdown.innerHTML += '<option value="menu">Return to Menu</option>';
            
            modal.style.display = 'flex';
        }

        // Handle lesson complete action
        function handleLessonComplete() {
            const dropdown = document.getElementById('nextActionDropdown');
            const action = dropdown.value;
            const modal = document.getElementById('lessonCompleteModal');
            
            modal.style.display = 'none';
            
            if (action === 'next') {
                // Start next lesson
                const currentLessonIndex = availableLessons.indexOf(gameState.currentLesson);
                const nextLesson = availableLessons[currentLessonIndex + 1];
                
                if (nextLesson) {
                    const lessonDropdown = document.getElementById('lessonDropdown');
                    lessonDropdown.value = nextLesson;
                    startSelectedLesson();
                }
            } else {
                // Return to menu
                returnToWelcomeScreen();
            }
        }

        // Return to welcome screen
        function returnToWelcomeScreen() {
            // Reset game state
            gameState.currentLesson = null;
            gameState.currentLessonWords = [];
            gameState.gameStarted = false;
            gameState.currentWordIndex = 0;
            
            // Hide all game elements
            hideInitialGuessInput();
            hideCluePhase();
            document.getElementById('gameCompleteContainer').style.display = 'none';
            document.getElementById('audioControls').style.display = 'none';
            document.getElementById('progressCounter').style.display = 'none';
            
            // Show welcome screen
            document.getElementById('welcomeScreen').style.display = 'flex';
            
            // Reset lesson dropdown
            document.getElementById('lessonDropdown').value = '';
            document.getElementById('startLessonButton').disabled = true;
        }

        // Initialize lessons on page load
        async function initializeLessons() {
            try {
                console.log('Starting lesson initialization...');
                await loadLessons();
                populateLessonDropdown();
                console.log('Lessons initialized successfully');
            } catch (error) {
                console.error('Failed to initialize lessons:', error);
                // Show fallback option if lessons fail to load
                showLessonLoadFallback();
                showErrorModal(error);
            }
        }

        // Track guesses for lesson stats
        function trackGuess(isCorrect) {
            gameState.totalGuesses++;
            if (isCorrect) {
                gameState.correctGuesses++;
            }
        }

        /**
         * Spelling Evaluator namespace containing all evaluation functions
         */
        const SpellingEvaluator = {
            /**
             * Marks length differences between guess and target words.
             * Handles cases where guess is longer (extraneous letters) or shorter (missing letters) than target.
             * @param {number} guessLength - Length of the guess word
             * @param {number} targetLength - Length of the target word
             * @param {Object} result - Result object containing feedback, extraneous, and missing arrays
             * @private
             */
            _markLengthDifferences(guessLength, targetLength, result) {
                if (guessLength > targetLength) {
                    // Mark extra letters as extraneous
                    for (let i = targetLength; i < guessLength; i++) {
                        result.extraneous[i] = true;
                    }
                } else if (guessLength < targetLength) {
                    // Mark missing positions
                    for (let i = guessLength; i < targetLength; i++) {
                        result.feedback[i] = 'missing';
                        result.missing[i] = true;
                    }
                }
            },

            /**
             * Processes exact position matches between guess and target (green letters).
             * Only checks the overlapping portion of both words for character-by-character matches.
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @param {Object} result - Result object containing the feedback array
             * @param {boolean[]} targetUsed - Array tracking which target positions have been matched
             * @param {boolean[]} guessUsed - Array tracking which guess positions have been matched
             * @private
             */
            _processExactMatches(guess, target, result, targetUsed, guessUsed) {
                const overlapLength = Math.min(guess.length, target.length);
                
                for (let i = 0; i < overlapLength; i++) {
                    if (guess[i] === target[i]) {
                        result.feedback[i] = 'green';
                        targetUsed[i] = true;
                        guessUsed[i] = true;
                    }
                }
            },

            /**
             * Processes wrong position matches between guess and target (yellow letters).
             * Finds letters that exist in target but are in wrong positions in guess.
             * Only processes letters not already matched in exact positions.
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @param {Object} result - Result object containing the feedback array
             * @param {boolean[]} targetUsed - Array tracking which target positions have been matched
             * @param {boolean[]} guessUsed - Array tracking which guess positions have been matched
             * @private
             */
            _processWrongPositions(guess, target, result, targetUsed, guessUsed) {
                for (let i = 0; i < guess.length; i++) {
                    if (guessUsed[i]) continue; // Already matched as green
                    
                    for (let j = 0; j < target.length; j++) {
                        if (!targetUsed[j] && guess[i] === target[j]) {
                            result.feedback[i] = 'yellow';
                            targetUsed[j] = true;
                            guessUsed[i] = true;
                            break; // Only match one occurrence
                        }
                    }
                }
            },

            /**
             * Evaluates a spelling guess against a target word.
             * Returns an object with:
             *   - feedback: array of 'green', 'yellow', 'gray', or 'missing'
             *   - extraneous: array of booleans (true for extraneous letters)
             *   - missing: array of booleans (true for missing letter positions)
             * @param {string} guess - The word being guessed
             * @param {string} target - The target word to match against
             * @returns {Object} { feedback: string[], extraneous: boolean[], missing: boolean[] }
             */
            evaluate(guess, target) {
                const guessLength = guess.length;
                const targetLength = target.length;
                const maxLength = Math.max(guessLength, targetLength);
                
                // Initialize result object and tracking arrays
                const result = {
                    feedback: Array(maxLength).fill('gray'),
                    extraneous: Array(maxLength).fill(false),
                    missing: Array(maxLength).fill(false)
                };
                
                const targetUsed = Array(targetLength).fill(false);
                const guessUsed = Array(guessLength).fill(false);

                // Process evaluation in logical steps
                this._markLengthDifferences(guessLength, targetLength, result);
                this._processExactMatches(guess, target, result, targetUsed, guessUsed);
                this._processWrongPositions(guess, target, result, targetUsed, guessUsed);

                return result;
            },

            /**
             * Checks if the guess is a win (exact match: case, length, content).
             * @param {string} guess - The guessed word
             * @param {string} target - The target word
             * @returns {boolean} True if guess exactly matches target
             */
            isWin(guess, target) {
                return guess === target;
            }
        };

        // Check for text-to-speech support
        function checkTTSSupport() {
            if ('speechSynthesis' in window) {
                synth = window.speechSynthesis;
                ttsSupported = true;
                console.log('Text-to-speech supported');
            } else {
                ttsSupported = false;
                console.log('Text-to-speech not supported');
                showAudioFallback();
            }
        }

        // Show audio fallback message
        function showAudioFallback() {
            const fallbackDiv = document.getElementById('audioFallback');
            fallbackDiv.style.display = 'block';
        }

        // Create speech utterance with pause between word and sentence
        function createUtterance(word, sentence) {
            if (!ttsSupported) return null;
            
            // Create text with slight pause between word and sentence
            const textToSpeak = `${word}... ${sentence}`;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            // Use browser default voice at normal rate
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Handle TTS errors gracefully
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
            };
            
            return utterance;
        }

        // Speak the current word and sentence
        function speakCurrentWord() {
            if (!ttsSupported || !gameState.currentWord || !gameState.currentSentence) {
                return;
            }
            
            // Stop any current speech
            if (synth.speaking) {
                synth.cancel();
            }
            
            // Create and cache the utterance
            currentUtterance = createUtterance(gameState.currentWord, gameState.currentSentence);
            
            if (currentUtterance) {
                // Enable repeat button when speech starts
                const repeatButton = document.getElementById('repeatButton');
                repeatButton.disabled = false;
                
                synth.speak(currentUtterance);
                console.log(`Speaking: ${gameState.currentWord}... ${gameState.currentSentence}`);
            }
        }

        // Repeat the current word (replays same cached audio)
        function repeatWord() {
            if (!ttsSupported || !currentUtterance) {
                return;
            }
            
            // Stop any current speech
            if (synth.speaking) {
                synth.cancel();
            }
            
            // Replay the same cached utterance
            synth.speak(currentUtterance);
            console.log('Repeating word');
        }

        // Speak "Correct!" announcement
        function speakCorrect() {
            if (!ttsSupported) return;
            
            const correctUtterance = new SpeechSynthesisUtterance('Correct!');
            correctUtterance.rate = 1.0;
            correctUtterance.pitch = 1.0;
            correctUtterance.volume = 1.0;
            
            correctUtterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
            };
            
            if (synth.speaking) {
                synth.cancel();
            }
            
            synth.speak(correctUtterance);
        }

        // Handle input field keydown events
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitGuess();
            }
        }

        // Handle input changes for case handling
        function handleInputChange(event) {
            const input = event.target;
            const value = input.value;
            
            // Clear any validation messages when user starts typing
            clearValidationMessage();
            
            // Convert to lowercase unless Caps Lock or Shift is engaged
            try {
                if (!event.getModifierState || (!event.getModifierState('CapsLock') && !event.getModifierState('Shift'))) {
                    // Only convert if the last character added was uppercase
                    const lastChar = value.slice(-1);
                    if (lastChar && lastChar === lastChar.toUpperCase() && lastChar !== lastChar.toLowerCase()) {
                        input.value = value.slice(0, -1) + lastChar.toLowerCase();
                    }
                }
            } catch (error) {
                // Fallback for browsers that don't support getModifierState
                console.log('getModifierState not supported, using fallback');
            }
        }

        // Show validation message
        function showValidationMessage(message) {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = message;
        }

        // Clear validation message
        function clearValidationMessage() {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = '';
        }

        // Submit the current guess
        function submitGuess() {
            const input = document.getElementById('guessInput');
            const guess = input.value.trim();
            
            // Prevent empty submissions
            if (!guess) {
                showValidationMessage('Please enter a guess before submitting.');
                input.focus();
                return;
            }
            
            clearValidationMessage();
            console.log(`User guessed: "${guess}" for target: "${gameState.currentWord}"`);
            
            // Case-sensitive word comparison
            if (guess === gameState.currentWord) {
                // Correct guess - play "Correct!" and advance to next word
                handleCorrectGuess();
            } else {
                // Incorrect guess - transition to Clue Phase
                handleIncorrectGuess(guess);
            }
        }

        // Handle correct guess
        function handleCorrectGuess() {
            console.log('Correct guess!');
            
            // Track the guess for lesson stats
            trackGuess(true);
            
            // Disable input during transition
            disableInputs();
            
            // Play "Correct!" via text-to-speech
            speakCorrect();
            
            // Advance to next word after brief delay
            setTimeout(() => {
                advanceToNextWord();
            }, 1500); // 1.5 second delay to let "Correct!" play
        }

        // Handle incorrect guess
        function handleIncorrectGuess(guess) {
            console.log(`Incorrect guess: "${guess}"`);
            
            // Track the guess for lesson stats
            trackGuess(false);
            
            // Transition to Clue Phase (don't clear screen)
            gameState.currentPhase = 'clue';
            
            // Hide the initial guess input
            hideInitialGuessInput();
            
            // Show clue phase feedback
            showCluePhase(guess);
        }

        // Clear and focus the input field
        function clearAndFocusInput() {
            const input = document.getElementById('guessInput');
            input.value = '';
            clearValidationMessage();
            input.focus();
        }

        // Show the initial guess input
        function showInitialGuessInput() {
            const container = document.getElementById('initialGuessContainer');
            container.style.display = 'flex';
            
            // Enable inputs and focus the input field after a brief delay
            setTimeout(() => {
                enableInputs();
                clearAndFocusInput();
            }, 100);
        }

        // Hide the initial guess input
        function hideInitialGuessInput() {
            const container = document.getElementById('initialGuessContainer');
            container.style.display = 'none';
        }

        // Render feedback boxes from SpellingEvaluator results
        function renderFeedbackBoxes(guess, target, evaluation) {
            const { feedback, extraneous, missing } = evaluation;
            const boxes = [];
            
            for (let i = 0; i < feedback.length; i++) {
                const letter = missing[i] ? '' : (guess[i] || '');
                const colorClass = feedback[i];
                const extraneousClass = extraneous[i] ? ' extraneous' : '';
                const missingClass = missing[i] ? ' missing' : '';
                
                boxes.push(`<div class="letter-box ${colorClass}${extraneousClass}${missingClass}">${letter}</div>`);
            }
            
            return boxes.join('');
        }

        // Show the clue phase with feedback
        function showCluePhase(guess) {
            const container = document.getElementById('cluePhaseContainer');
            container.style.display = 'flex';
            
            // Create wrapper for feedback rows if it doesn't exist
            let wrapper = container.querySelector('.feedback-rows-wrapper');
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.className = 'feedback-rows-wrapper';
                container.appendChild(wrapper);
            }
            
            // Evaluate the guess using SpellingEvaluator
            const evaluation = SpellingEvaluator.evaluate(guess, gameState.currentWord);
            console.log('Evaluation result:', evaluation);
            
            // Create feedback row
            const feedbackRow = document.createElement('div');
            feedbackRow.className = 'feedback-row';
            feedbackRow.innerHTML = renderFeedbackBoxes(guess, gameState.currentWord, evaluation);
            
            // Add the feedback row to the wrapper
            wrapper.appendChild(feedbackRow);
            
            // Add input row for next guess
            addInputRow(wrapper);
            
            console.log(`Displayed feedback for guess: "${guess}" vs target: "${gameState.currentWord}"`);
        }

        // Add input row with individual letter boxes
        function addInputRow(wrapper) {
            const inputRowContainer = document.createElement('div');
            inputRowContainer.className = 'input-row-container';
            
            // Create input row
            const inputRow = document.createElement('div');
            inputRow.className = 'input-row-clue';
            
            // Create individual input fields for each letter in target word
            for (let i = 0; i < gameState.currentWord.length; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'letter-input';
                input.maxLength = 1;
                input.value = ''; // Ensure input starts empty
                input.dataset.index = i;
                input.addEventListener('input', handleLetterInput);
                input.addEventListener('keydown', handleLetterKeydown);
                inputRow.appendChild(input);
            }
            
            inputRowContainer.appendChild(inputRow);
            
            // Create submit button
            const submitButton = document.createElement('button');
            submitButton.className = 'clue-submit-button';
            submitButton.textContent = 'Submit';
            submitButton.onclick = submitClueGuess;
            inputRowContainer.appendChild(submitButton);
            
            wrapper.appendChild(inputRowContainer);
            
            // Auto-focus first input box after a brief delay
            const firstInput = inputRow.querySelector('.letter-input');
            if (firstInput) {
                setTimeout(() => {
                    firstInput.focus();
                    firstInput.select(); // Ensure any existing content is selected
                }, 150);
            }
        }

        // Handle input in letter boxes
        function handleLetterInput(event) {
            const input = event.target;
            let value = input.value;
            
            // Only keep the last character if multiple were entered
            if (value.length > 1) {
                value = value.slice(-1);
                input.value = value;
            }
            
            // Convert to lowercase unless Caps Lock or Shift is engaged
            try {
                if (value && (!event.getModifierState || (!event.getModifierState('CapsLock') && !event.getModifierState('Shift')))) {
                    if (value === value.toUpperCase() && value !== value.toLowerCase()) {
                        input.value = value.toLowerCase();
                        value = value.toLowerCase();
                    }
                }
            } catch (error) {
                // Fallback for browsers that don't support getModifierState
                if (value && value === value.toUpperCase() && value !== value.toLowerCase()) {
                    input.value = value.toLowerCase();
                    value = value.toLowerCase();
                }
            }
            
            // Move to next box if letter was entered
            if (value) {
                const currentIndex = parseInt(input.dataset.index);
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select(); // Select any existing content
                }
            }
        }

        // Handle keydown events in letter boxes
        function handleLetterKeydown(event) {
            const input = event.target;
            const currentIndex = parseInt(input.dataset.index);
            
            if (event.key === 'Backspace') {
                // If current box is empty, move to previous box and clear it
                if (!input.value && currentIndex > 0) {
                    const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.select(); // Select content for easy replacement
                    }
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                submitClueGuess();
            } else if (event.key === 'ArrowLeft' && currentIndex > 0) {
                const prevInput = input.parentElement.querySelector(`[data-index="${currentIndex - 1}"]`);
                if (prevInput) {
                    prevInput.focus();
                    prevInput.select();
                }
            } else if (event.key === 'ArrowRight' && currentIndex < gameState.currentWord.length - 1) {
                const nextInput = input.parentElement.querySelector(`[data-index="${currentIndex + 1}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }

        // Submit clue phase guess
        function submitClueGuess() {
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            const lastInputRow = wrapper.querySelector('.input-row-container:last-child .input-row-clue');
            const inputs = lastInputRow.querySelectorAll('.letter-input');
            
            // Collect letters from input boxes
            let guess = '';
            let allFilled = true;
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (!value) {
                    allFilled = false;
                }
                guess += value;
            });
            
            // Prevent submission if not all boxes are filled
            if (!allFilled) {
                // Find first empty input and focus it
                const firstEmpty = Array.from(inputs).find(input => !input.value.trim());
                if (firstEmpty) {
                    firstEmpty.focus();
                }
                return;
            }
            
            console.log(`Clue phase guess: "${guess}" for target: "${gameState.currentWord}"`);
            
            // Check if guess is correct
            if (guess === gameState.currentWord) {
                // Correct guess - play "Correct!" and advance to next word
                handleCorrectGuess();
            } else {
                // Incorrect guess - add new feedback row and input row
                handleIncorrectClueGuess(guess);
            }
        }

        // Handle incorrect guess in clue phase
        function handleIncorrectClueGuess(guess) {
            console.log(`Incorrect clue guess: "${guess}"`);
            
            // Track the guess for lesson stats
            trackGuess(false);
            
            const container = document.getElementById('cluePhaseContainer');
            const wrapper = container.querySelector('.feedback-rows-wrapper');
            
            // Remove the current input row before adding feedback
            const currentInputContainer = wrapper.querySelector('.input-row-container:last-child');
            if (currentInputContainer) {
                currentInputContainer.remove();
            }
            
            // Evaluate the guess using SpellingEvaluator
            const evaluation = SpellingEvaluator.evaluate(guess, gameState.currentWord);
            console.log('Clue evaluation result:', evaluation);
            
            // Create new feedback row
            const feedbackRow = document.createElement('div');
            feedbackRow.className = 'feedback-row';
            feedbackRow.innerHTML = renderFeedbackBoxes(guess, gameState.currentWord, evaluation);
            
            // Add the feedback row to the wrapper
            wrapper.appendChild(feedbackRow);
            
            // Add new input row for next attempt with cleared boxes
            addInputRow(wrapper);
        }

        // Disable inputs during transitions
        function disableInputs() {
            const guessInput = document.getElementById('guessInput');
            const submitButton = document.getElementById('submitButton');
            const clueInputs = document.querySelectorAll('.letter-input');
            const clueSubmitButtons = document.querySelectorAll('.clue-submit-button');
            
            if (guessInput) guessInput.disabled = true;
            if (submitButton) submitButton.disabled = true;
            clueInputs.forEach(input => input.disabled = true);
            clueSubmitButtons.forEach(button => button.disabled = true);
        }

        // Enable inputs after transitions
        function enableInputs() {
            const guessInput = document.getElementById('guessInput');
            const submitButton = document.getElementById('submitButton');
            const clueInputs = document.querySelectorAll('.letter-input');
            const clueSubmitButtons = document.querySelectorAll('.clue-submit-button');
            
            if (guessInput) guessInput.disabled = false;
            if (submitButton) submitButton.disabled = false;
            clueInputs.forEach(input => input.disabled = false);
            clueSubmitButtons.forEach(button => button.disabled = false);
        }

        // Hide the clue phase
        function hideCluePhase() {
            const container = document.getElementById('cluePhaseContainer');
            container.style.display = 'none';
            // Clear all feedback rows
            container.innerHTML = '';
        }

        // Get current word data (updated for lessons)
        function getCurrentWordData() {
            if (gameState.currentLessonWords.length > 0) {
                if (gameState.currentWordIndex < gameState.currentLessonWords.length) {
                    const row = gameState.currentLessonWords[gameState.currentWordIndex];
                    return { word: row.word, sentence: row.sentence };
                }
            } else {
                // Fallback to hardcoded words
                if (gameState.currentWordIndex < fallbackWordList.length) {
                    return fallbackWordList[gameState.currentWordIndex];
                }
            }
            return null;
        }

        // Update progress counter display
        function updateProgressCounter() {
            const progressCounter = document.getElementById('progressCounter');
            if (gameState.currentLesson) {
                progressCounter.textContent = `${gameState.currentLesson} - Word ${gameState.currentWordIndex + 1} of ${gameState.totalWords}`;
            } else {
                progressCounter.textContent = `Word ${gameState.currentWordIndex + 1} of ${gameState.totalWords}`;
            }
            progressCounter.style.display = 'block';
        }

        // Advance to next word
        function advanceToNextWord() {
            gameState.currentWordIndex++;
            if (gameState.currentWordIndex < gameState.totalWords) {
                // Reset to Initial Guess Phase for new word
                gameState.currentPhase = 'initial';
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    updateProgressCounter();
                    
                    // Hide clue phase and show initial guess input for new word
                    hideCluePhase();
                    showInitialGuessInput();
                    
                    // Auto-play the new word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500); // Brief delay before speaking
                    
                    console.log(`Advanced to word ${gameState.currentWordIndex + 1}: ${gameState.currentWord}`);
                } else {
                    console.error('Failed to get word data for index:', gameState.currentWordIndex);
                    handleGameCompletion();
                }
            } else {
                // Handle game completion (after word 12)
                handleGameCompletion();
            }
        }

        // Updated game completion handler
        function handleGameCompletion() {
            if (gameState.currentLesson) {
                handleLessonCompletion();
            } else {
                // Original game complete behavior
                console.log('Game completed!');
                hideInitialGuessInput();
                hideCluePhase();
                const gameCompleteContainer = document.getElementById('gameCompleteContainer');
                gameCompleteContainer.style.display = 'flex';
            }
        }

        // Play again functionality
        function playAgain() {
            console.log('Starting new game');
            
            try {
                // Reset game state to word 1
                gameState.currentWordIndex = 0;
                gameState.currentPhase = 'initial';
                gameState.gameStarted = true;
                
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    
                    // Update progress counter
                    updateProgressCounter();
                    
                    // Hide game complete container and clue phase
                    const gameCompleteContainer = document.getElementById('gameCompleteContainer');
                    gameCompleteContainer.style.display = 'none';
                    hideCluePhase();
                    
                    // Clear any validation messages
                    clearValidationMessage();
                    
                    // Show initial guess input
                    showInitialGuessInput();
                    
                    // Auto-play the first word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500);
                } else {
                    console.error('Failed to reset game - no word data available');
                }
            } catch (error) {
                console.error('Error during game reset:', error);
            }
        }

        // Initialize the game
        function initializeGame() {
            try {
                gameState.gameStarted = true;
                gameState.currentWordIndex = 0;
                gameState.currentPhase = 'initial';
                
                const wordData = getCurrentWordData();
                if (wordData) {
                    gameState.currentWord = wordData.word;
                    gameState.currentSentence = wordData.sentence;
                    
                    updateProgressCounter();
                    
                    // Hide welcome screen and start button
                    const welcomeScreen = document.getElementById('welcomeScreen');
                    if (welcomeScreen) welcomeScreen.style.display = 'none';
                    
                    const startButton = document.getElementById('startButton');
                    startButton.style.display = 'none';
                    
                    const audioControls = document.getElementById('audioControls');
                    audioControls.style.display = 'flex';
                    
                    // Show initial guess input
                    showInitialGuessInput();
                    
                    // Auto-play the first word
                    setTimeout(() => {
                        speakCurrentWord();
                    }, 500); // Brief delay to let UI update
                    
                    console.log('Game initialized');
                    console.log(`Current word: ${gameState.currentWord}`);
                    console.log(`Current sentence: ${gameState.currentSentence}`);
                } else {
                    console.error('Failed to initialize game - no word data available');
                }
            } catch (error) {
                console.error('Error during game initialization:', error);
            }
        }

        // Initialize the page when it loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Spelldle initialized');
                console.log('Current game state:', gameState);
                updateProgressCounter();
                checkTTSSupport();
                
                // Initialize lessons
                initializeLessons();
                
                // Validate fallback word list
                if (fallbackWordList.length !== 12) {
                    console.warn(`Expected 12 fallback words, found ${fallbackWordList.length}`);
                }
                
                // Validate each fallback word entry
                fallbackWordList.forEach((entry, index) => {
                    if (!entry.word || !entry.sentence) {
                        console.error(`Invalid fallback word entry at index ${index}:`, entry);
                    }
                });
                
                // Test SpellingEvaluator integration (only in development)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('Testing SpellingEvaluator integration:');
                    const testResult = SpellingEvaluator.evaluate('hello', 'world');
                    console.log('SpellingEvaluator.evaluate("hello", "world"):', testResult);
                    console.log('SpellingEvaluator.isWin("friend", "friend"):', SpellingEvaluator.isWin('friend', 'friend'));
                    console.log('SpellingEvaluator.isWin("friend", "fiend"):', SpellingEvaluator.isWin('friend', 'fiend'));
                }
            } catch (error) {
                console.error('Error during page initialization:', error);
            }
        });
    </script>
</body>
</html>
